"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["633"],{9160(e,t,l){l.r(t),l.d(t,{Component:()=>M});var a=l(4848),r=l(7833),i=l(2454),s=l(6287),n=l(8150),o=l(4840),u=l(3133),c=l(8448),p=l(2685),d=l(8361),h=l(8032),m=l(4353),f=l.n(m),y=l(6540),b=l(3433),g=l(391),v=l(1568);let{Title:x}=s.A,{RangePicker:j}=n.A,A="查询热更次数",S=e=>{if(!e)return{label:"unknown",isTotal:!1};if("_total"===e||"total"===e)return{label:A,isTotal:!0};let t=e.split("\x1f");if(t.length>=2){let e=t[0],l=t.slice(1).join("\x1f")||"unknown";if("hash"===e)return{label:`热更包: ${l}`,attribute:"hash",isTotal:!1};if("packageVersion_buildTime"===e)return{label:`原生包: ${l}`,attribute:"packageVersion_buildTime",isTotal:!1}}return e.endsWith("\x1f")?{label:e.replace("\x1f",": unknown"),isTotal:!1}:{label:e.replace("\x1f",": "),isTotal:!1}},T=[{label:"热更包",value:"hash"},{label:"原生包",value:"packageVersion_buildTime"}],M=()=>{let[e,t]=(0,b.ok)(),[l,s]=(0,y.useState)([f()().subtract(24,"hour"),f()()]),[n,m]=(0,y.useState)(e.get("appKey")||void 0),[M,w]=(0,y.useState)(""),[k,K]=(0,y.useState)("hash"),F=(0,y.useRef)([]),C=(0,y.useRef)(""),{apps:_}=(0,v.vu)(),{user:I}=(0,v.Py)(),N=(null==I?void 0:I.admin)===!0,E=(0,y.useMemo)(()=>(_||[]).filter(e=>!!e.appKey).map(e=>({label:e.name,value:e.appKey})),[_]);(0,y.useEffect)(()=>{let t=e.get("appKey");t&&t!==n&&(N||E.some(e=>e.value===t))&&m(t)},[e,N,E,n]),(0,y.useEffect)(()=>{if(!n&&E.length>0&&!e.get("appKey")){let e=E[0].value;m(e),t({appKey:e},{replace:!0})}},[E,n,e,t]),(0,y.useEffect)(()=>{C.current=""},[n,l,k]);let{data:O,isLoading:R}=(0,i.I)({queryKey:["appMetrics",n,l[0].toISOString(),l[1].toISOString()],queryFn:()=>g.F.getAppMetrics({appKey:n,start:l[0].toISOString(),end:l[1].toISOString()}),enabled:!!n&&!!l[0]&&!!l[1]}),V=(0,y.useMemo)(()=>{if(!(null==O?void 0:O.data)||!(null==O?void 0:O.dict))return[];let e=[];for(let t of O.data)for(let[l,a]of t.data){let{label:r,attribute:i,isTotal:s}=S(O.dict[l]||"");e.push({time:t.time,value:a,category:r,attribute:i,isTotal:s})}return e},[O]),D=(0,y.useMemo)(()=>V.filter(e=>e.isTotal||e.attribute===k),[V,k]),P=(0,y.useMemo)(()=>{let e=new Map;for(let t of D)t.isTotal||e.set(t.category,(e.get(t.category)||0)+t.value);return e},[D]),q=(0,y.useMemo)(()=>Array.from(P.entries()).sort((e,t)=>t[1]-e[1]).map(e=>{let[t]=e;return t}),[P]),B=(0,y.useMemo)(()=>D.some(e=>e.isTotal),[D]),H=(0,y.useMemo)(()=>{let e=q.slice(0,10);return B?[A,...e]:e},[q,B]),$=(0,y.useMemo)(()=>B?[A,...q]:q,[q,B]);F.current=H;let z={interaction:{legendFilter:!0,tooltip:{shared:!0}},data:D,xField:e=>new Date(e.time),yField:"value",colorField:"category",shapeField:"smooth",axis:{x:{title:"时间",labelAutoRotate:!0,labelFormatter:e=>{let t=f()(e);return t.isValid()?t.format("MM/DD HH:mm"):e}},y:{}},tooltip:{channel:"y"},legend:{position:"top"},scale:$.length?{color:{domain:$}}:void 0,onReady:e=>{let{chart:t}=e;try{t.on("afterrender",()=>{let e=F.current;if(!e.length)return;let l=e.join("|");l!==C.current&&(t.emit("legend:filter",{data:{channel:"color",values:e}}),C.current=l)})}catch(e){console.error(e)}},height:480};return(0,a.jsx)("div",{className:"p-6",children:(0,a.jsxs)(o.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsx)(x,{level:4,className:"m-0!",children:"实时数据"}),(0,a.jsxs)(u.A,{children:[(0,a.jsx)(c.A,{placeholder:"选择应用",showSearch:!0,optionFilterProp:"label",value:n,onChange:e=>{m(e),t({appKey:e},{replace:!0})},options:E,style:{width:200}}),(0,a.jsx)(p.A.Group,{value:k,onChange:e=>K(e.target.value),optionType:"button",buttonStyle:"solid",children:T.map(e=>(0,a.jsx)(p.A.Button,{value:e.value,children:e.label},e.value))}),N&&(0,a.jsx)(d.A,{placeholder:"输入任意 App Key",value:M,onChange:e=>w(e.target.value),onPressEnter:()=>{M.trim()&&(m(M.trim()),t({appKey:M.trim()},{replace:!0}),w(""))},style:{width:180}}),(0,a.jsx)(j,{showTime:!0,value:l,onChange:e=>{(null==e?void 0:e[0])&&e[1]&&s([e[0],e[1]])},presets:[{label:"过去1小时",value:[f()().subtract(1,"hour"),f()()]},{label:"过去6小时",value:[f()().subtract(6,"hour"),f()()]},{label:"过去24小时",value:[f()().subtract(24,"hour"),f()()]},{label:"过去7天",value:[f()().subtract(7,"day"),f()()]}]})]})]}),(0,a.jsx)(h.A,{spinning:R,children:(0,a.jsx)(o.A,{size:"small",style:{marginBottom:20},children:n?D.length>0?(0,a.jsx)(r.A,{...z}):(0,a.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"暂无数据"}):(0,a.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"请选择应用"})})})]})})}}}]);