"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["897"],{9120(e,t,s){s.r(t),s.d(t,{Component:()=>C});var i=s(4848),n=s(4123),r=s(6029),a=s(4022),o=s(7665),l=s(2454),u=s(5419),c=s(6287),d=s(6380),h=s(1215),m=s(3133),p=s(6845),x=s(5021),y=s(400),A=s(4840),j=s(6992),k=s(2387),v=s(8361),b=s(518),f=s(8448),g=s(4353),T=s.n(g),I=s(6540),M=s(391);let{Paragraph:O}=c.A,C=function(){let e=(0,o.jE)(),[t,s]=(0,I.useState)(!1),[c,g]=(0,I.useState)(null),[C]=d.A.useForm(),{data:R,isLoading:S}=(0,l.I)({queryKey:["apiTokens"],queryFn:M.F.listApiTokens}),w=(0,u.n)({mutationFn:M.F.createApiToken,onSuccess:t=>{(null==t?void 0:t.token)&&(g(t.token),s(!1),h.Ay.success("API Token 创建成功"),e.invalidateQueries({queryKey:["apiTokens"]}),C.resetFields())},onError:e=>{h.Ay.error(e.message||"创建失败")}}),P=(0,u.n)({mutationFn:M.F.revokeApiToken,onSuccess:()=>{h.Ay.success("Token 已撤销"),e.invalidateQueries({queryKey:["apiTokens"]})},onError:e=>{h.Ay.error(e.message||"撤销失败")}}),E=async e=>{var t,s,i;let n={read:null==(t=e.permissions)?void 0:t.includes("read"),write:null==(s=e.permissions)?void 0:s.includes("write"),delete:null==(i=e.permissions)?void 0:i.includes("delete")},r=e.expiresIn?T()().add(e.expiresIn,"day").toISOString():void 0;await w.mutateAsync({name:e.name,permissions:n,expiresAt:r})},Y=[{title:"ID",dataIndex:"id",key:"id",width:60},{title:"名称",dataIndex:"name",key:"name",render:(e,t)=>(0,i.jsxs)(m.A,{children:[(0,i.jsx)(n.A,{}),e,t.isRevoked&&(0,i.jsx)(p.A,{color:"red",children:"已撤销"}),t.isExpired&&!t.isRevoked&&(0,i.jsx)(p.A,{color:"orange",children:"已过期"})]})},{title:"Token",dataIndex:"tokenSuffix",key:"tokenSuffix",render:e=>(0,i.jsxs)("span",{className:"font-mono text-gray-500",children:["****",e]})},{title:"权限",dataIndex:"permissions",key:"permissions",render:e=>(0,i.jsxs)(m.A,{children:[(null==e?void 0:e.read)&&(0,i.jsx)(p.A,{color:"blue",children:"读取"}),(null==e?void 0:e.write)&&(0,i.jsx)(p.A,{color:"green",children:"写入"}),(null==e?void 0:e.delete)&&(0,i.jsx)(p.A,{color:"red",children:"删除"})]})},{title:"过期时间",dataIndex:"expiresAt",key:"expiresAt",render:e=>e?T()(e).format("YYYY-MM-DD HH:mm"):"永不过期"},{title:"最后使用",dataIndex:"lastUsedAt",key:"lastUsedAt",render:e=>e?T()(e).format("YYYY-MM-DD HH:mm"):"从未使用"},{title:"创建时间",dataIndex:"createdAt",key:"createdAt",render:e=>T()(e).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",render:(e,t)=>(0,i.jsx)(x.A,{title:"确认撤销",description:"撤销后此 Token 将无法再使用，确定要撤销吗？",onConfirm:()=>P.mutate(t.id),okText:"确定",cancelText:"取消",disabled:t.isRevoked,children:(0,i.jsx)(y.Ay,{type:"text",danger:!0,icon:(0,i.jsx)(r.A,{}),disabled:t.isRevoked,children:"撤销"})})}];return(0,i.jsxs)("div",{className:"body",children:[(0,i.jsxs)(A.A,{title:"API Token 管理",extra:(0,i.jsx)(y.Ay,{type:"primary",icon:(0,i.jsx)(n.A,{}),onClick:()=>s(!0),children:"创建 Token"}),children:[(0,i.jsxs)(O,{type:"secondary",className:"mb-4",children:["API Token 可用于 CI/CD 流程或自动化脚本中调用"," ",(0,i.jsx)("a",{target:"_blank",href:"https://update.reactnative.cn/api/openapi",rel:"noopener",children:"Pushy API"}),"。每个用户最多可同时保留 10 个活跃的 Token。"]}),(0,i.jsx)(j.A,{columns:Y,dataSource:null==R?void 0:R.data,loading:S,rowKey:"id",pagination:!1})]}),(0,i.jsx)(k.A,{title:"创建 API Token",open:t,onCancel:()=>{s(!1),C.resetFields()},footer:null,destroyOnClose:!0,children:(0,i.jsxs)(d.A,{form:C,layout:"vertical",onFinish:E,children:[(0,i.jsx)(d.A.Item,{label:"Token 名称",name:"name",rules:[{required:!0,message:"请输入 Token 名称"}],children:(0,i.jsx)(v.A,{placeholder:"例如：CI/CD Pipeline",maxLength:100})}),(0,i.jsx)(d.A.Item,{label:"权限",name:"permissions",rules:[{required:!0,message:"请至少选择一个权限"}],children:(0,i.jsx)(b.A.Group,{children:(0,i.jsxs)(m.A,{direction:"vertical",children:[(0,i.jsxs)(b.A,{value:"read",children:[(0,i.jsx)("b",{children:"读取 (read)"})," - 查看应用、版本、原生包信息"]}),(0,i.jsxs)(b.A,{value:"write",children:[(0,i.jsx)("b",{children:"写入 (write)"})," - 创建和更新应用、发布版本、上传原生包"]}),(0,i.jsxs)(b.A,{value:"delete",children:[(0,i.jsx)("b",{children:"删除 (delete)"})," - 删除应用、版本、原生包"]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"注意：写入权限不包括读取权限，如需同时读取请勾选读取权限"})]})})}),(0,i.jsx)(d.A.Item,{label:"过期时间",name:"expiresIn",initialValue:180,children:(0,i.jsx)(f.A,{options:[{value:0,label:"永不过期"},{value:30,label:"30 天"},{value:90,label:"90 天"},{value:180,label:"180 天"},{value:360,label:"360 天"}]})}),(0,i.jsx)(d.A.Item,{className:"mb-0",children:(0,i.jsx)(y.Ay,{type:"primary",htmlType:"submit",loading:w.isPending,block:!0,children:"创建"})})]})}),(0,i.jsx)(k.A,{title:"Token 创建成功",open:!!c,onOk:()=>g(null),onCancel:()=>g(null),cancelButtonProps:{style:{display:"none"}},okText:"我已保存",children:(0,i.jsxs)("div",{className:"my-4",children:[(0,i.jsx)(O,{type:"warning",className:"mb-2",children:"⚠️ 请立即复制并安全保存此 Token，关闭后将无法再次查看！"}),(0,i.jsx)(v.A.TextArea,{value:c||"",readOnly:!0,autoSize:{minRows:2},className:"font-mono"}),(0,i.jsx)(y.Ay,{icon:(0,i.jsx)(a.A,{}),className:"mt-2",onClick:()=>{c&&(navigator.clipboard.writeText(c),h.Ay.success("已复制到剪贴板"))},children:"复制 Token"})]})})]})}},5419(e,t,s){s.d(t,{n:()=>c});var i=s(6540),n=s(6158),r=s(6261),a=s(6500),o=s(4880),l=class extends a.Q{#e;#t=void 0;#s;#i;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#n()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,o.f8)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#s,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,o.EN)(t.mutationKey)!==(0,o.EN)(this.options.mutationKey)?this.reset():this.#s?.state.status==="pending"&&this.#s.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#s?.removeObserver(this)}onMutationUpdate(e){this.#n(),this.#r(e)}getCurrentResult(){return this.#t}reset(){this.#s?.removeObserver(this),this.#s=void 0,this.#n(),this.#r()}mutate(e,t){return this.#i=t,this.#s?.removeObserver(this),this.#s=this.#e.getMutationCache().build(this.#e,this.options),this.#s.addObserver(this),this.#s.execute(e)}#n(){let e=this.#s?.state??(0,n.$)();this.#t={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#r(e){r.jG.batch(()=>{if(this.#i&&this.hasListeners()){let t=this.#t.variables,s=this.#t.context,i={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};if(e?.type==="success"){try{this.#i.onSuccess?.(e.data,t,s,i)}catch(e){Promise.reject(e)}try{this.#i.onSettled?.(e.data,null,t,s,i)}catch(e){Promise.reject(e)}}else if(e?.type==="error"){try{this.#i.onError?.(e.error,t,s,i)}catch(e){Promise.reject(e)}try{this.#i.onSettled?.(void 0,e.error,t,s,i)}catch(e){Promise.reject(e)}}}this.listeners.forEach(e=>{e(this.#t)})})}},u=s(7665);function c(e,t){let s=(0,u.jE)(t),[n]=i.useState(()=>new l(s,e));i.useEffect(()=>{n.setOptions(e)},[n,e]);let a=i.useSyncExternalStore(i.useCallback(e=>n.subscribe(r.jG.batchCalls(e)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),c=i.useCallback((e,t)=>{n.mutate(e,t).catch(o.lQ)},[n]);if(a.error&&(0,o.GU)(n.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}}}]);