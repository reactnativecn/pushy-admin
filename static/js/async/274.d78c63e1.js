"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["274"],{6113(t,e,s){s.r(e),s.d(e,{Component:()=>I});var i=s(4848),r=s(6385),n=s(4811),a=s(7665),u=s(2454),l=s(5419),o=s(6287),c=s(6380),d=s(1215),h=s(400),m=s(4840),p=s(8361),y=s(8032),x=s(8424),A=s(6615),f=s(3133),v=s(8448),b=s(8150),g=s(4353),j=s.n(g),S=s(6540),C=s(271),O=s(7762);let{Title:E}=o.A,w=t=>{let{value:e,onChange:s}=t,r=(0,S.useRef)(null),n=(0,S.useRef)(null);return(0,S.useEffect)(()=>(r.current&&!n.current&&(n.current=new C.uL({target:r.current,props:{content:{text:e},onChange:(t,e,i)=>{let{contentErrors:r}=i;!r&&("json"in t&&void 0!==t.json?s(JSON.stringify(t.json,null,2)):"text"in t&&s(t.text))},mode:"text"}})),()=>{n.current&&(n.current.destroy(),n.current=null)}),[]),(0,S.useEffect)(()=>{n.current&&n.current.update({text:e})},[e]),(0,i.jsx)("div",{ref:r,style:{height:200}})},I=()=>{let t=(0,a.jE)(),[e,s]=(0,S.useState)(""),[o,g]=(0,S.useState)(""),[C,I]=(0,S.useState)(!1),[M,k]=(0,S.useState)(null),[N]=c.A.useForm(),[R,U]=(0,S.useState)("");(0,S.useEffect)(()=>{let t=setTimeout(()=>g(e),300);return()=>clearTimeout(t)},[e]);let{data:q,isLoading:K}=(0,u.I)({queryKey:["adminUsers",o],queryFn:()=>O.i.searchUsers(o||void 0)}),$=(0,l.n)({mutationFn:t=>{let{id:e,data:s}=t;return O.i.updateUser(e,s)},onSuccess:()=>{d.Ay.success("用户信息已更新"),I(!1),t.invalidateQueries({queryKey:["adminUsers"]})},onError:t=>{d.Ay.error(t.message)}}),P=async()=>{try{let t=await N.validateFields();if(!M)return;let e={tier:t.tier,status:t.status,tierExpiresAt:t.tierExpiresAt?t.tierExpiresAt.toISOString():null};if(R.trim())try{e.quota=JSON.parse(R)}catch{d.Ay.error("Quota 格式无效，请输入有效的 JSON");return}else e.quota=null;$.mutate({id:M.id,data:e})}catch(t){d.Ay.error(t.message)}},F=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"邮箱",dataIndex:"email",key:"email"},{title:"用户名",dataIndex:"name",key:"name"},{title:"状态",dataIndex:"status",key:"status",width:100,render:t=>(0,i.jsx)("span",{className:"normal"===t?"text-green-600":"text-orange-500",children:"normal"===t?"正常":"未验证"})},{title:"套餐",dataIndex:"tier",key:"tier",width:100},{title:"套餐过期时间",dataIndex:"tierExpiresAt",key:"tierExpiresAt",width:180,render:t=>t?j()(t).format("YYYY-MM-DD HH:mm"):"-"},{title:"自定义配额",dataIndex:"quota",key:"quota",width:100,render:t=>t?"有":"-"},{title:"操作",key:"action",width:80,render:(t,e)=>(0,i.jsx)(h.Ay,{type:"link",icon:(0,i.jsx)(r.A,{}),onClick:()=>{k(e),N.setFieldsValue({tier:e.tier,status:e.status,tierExpiresAt:e.tierExpiresAt?j()(e.tierExpiresAt):null}),U(e.quota?JSON.stringify(e.quota,null,2):""),I(!0)},children:"编辑"})}];return(0,i.jsxs)("div",{className:"p-6",children:[(0,i.jsxs)(m.A,{children:[(0,i.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,i.jsx)(E,{level:4,className:"m-0!",children:"用户管理"}),(0,i.jsx)(p.A,{placeholder:"搜索用户名或邮箱",prefix:(0,i.jsx)(n.A,{}),value:e,onChange:t=>s(t.target.value),style:{width:300},allowClear:!0})]}),(0,i.jsx)(y.A,{spinning:K,children:(0,i.jsx)(x.A,{dataSource:(null==q?void 0:q.data)||[],columns:F,rowKey:"id",pagination:{pageSize:20}})})]}),(0,i.jsx)(A.A,{title:`编辑用户: ${null==M?void 0:M.email}`,open:C,onCancel:()=>I(!1),footer:[(0,i.jsx)(h.Ay,{onClick:()=>I(!1),children:"取消"},"cancel"),(0,i.jsx)(h.Ay,{type:"primary",loading:$.isPending,onClick:P,children:"保存"},"save")],width:600,children:(0,i.jsx)(c.A,{form:N,layout:"vertical",className:"mt-4",children:(0,i.jsxs)(f.A,{className:"w-full",direction:"vertical",size:"middle",children:[(0,i.jsx)(c.A.Item,{name:"tier",label:"套餐",className:"mb-0!",children:(0,i.jsx)(v.A,{options:[{value:"free",label:"免费版"},{value:"standard",label:"标准版"},{value:"premium",label:"高级版"},{value:"pro",label:"专业版"},{value:"custom",label:"定制版"}]})}),(0,i.jsx)(c.A.Item,{name:"status",label:"状态",className:"mb-0!",children:(0,i.jsx)(v.A,{options:[{value:"normal",label:"正常"},{value:"unverified",label:"未验证"}]})}),(0,i.jsx)(c.A.Item,{name:"tierExpiresAt",label:"套餐过期时间",className:"mb-0!",children:(0,i.jsx)(b.A,{showTime:!0,className:"w-full"})}),(0,i.jsx)(c.A.Item,{label:"自定义配额 (JSON，留空则使用默认配额)",className:"mb-0!",children:(0,i.jsx)(w,{value:R,onChange:U})})]})})})]})}},7762(t,e,s){s.d(e,{i:()=>r});var i=s(6126);let r={getConfig:()=>(0,i.Ay)("get","/admin/config"),setConfig:(t,e)=>(0,i.Ay)("post","/admin/config",{key:t,value:e}),deleteConfig:t=>(0,i.Ay)("delete",`/admin/config/${t}`),searchUsers:t=>(0,i.Ay)("get",t?`/admin/users?search=${encodeURIComponent(t)}`:"/admin/users"),updateUser:(t,e)=>(0,i.Ay)("put",`/admin/users/${t}`,e),searchApps:t=>(0,i.Ay)("get",t?`/admin/apps?search=${encodeURIComponent(t)}`:"/admin/apps"),searchVersions:t=>{let e=new URLSearchParams;(null==t?void 0:t.search)&&e.set("search",t.search),(null==t?void 0:t.appId)&&e.set("appId",String(t.appId));let s=e.toString();return(0,i.Ay)("get",s?`/admin/versions?${s}`:"/admin/versions")},updateVersion:(t,e)=>(0,i.Ay)("put",`/admin/versions/${t}`,e),updateApp:(t,e)=>(0,i.Ay)("put",`/admin/apps/${t}`,e)}},5419(t,e,s){s.d(e,{n:()=>c});var i=s(6540),r=s(6158),n=s(6261),a=s(6500),u=s(4880),l=class extends a.Q{#t;#e=void 0;#s;#i;constructor(t,e){super(),this.#t=t,this.setOptions(e),this.bindMethods(),this.#r()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){let e=this.options;this.options=this.#t.defaultMutationOptions(t),(0,u.f8)(this.options,e)||this.#t.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#s,observer:this}),e?.mutationKey&&this.options.mutationKey&&(0,u.EN)(e.mutationKey)!==(0,u.EN)(this.options.mutationKey)?this.reset():this.#s?.state.status==="pending"&&this.#s.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#s?.removeObserver(this)}onMutationUpdate(t){this.#r(),this.#n(t)}getCurrentResult(){return this.#e}reset(){this.#s?.removeObserver(this),this.#s=void 0,this.#r(),this.#n()}mutate(t,e){return this.#i=e,this.#s?.removeObserver(this),this.#s=this.#t.getMutationCache().build(this.#t,this.options),this.#s.addObserver(this),this.#s.execute(t)}#r(){let t=this.#s?.state??(0,r.$)();this.#e={...t,isPending:"pending"===t.status,isSuccess:"success"===t.status,isError:"error"===t.status,isIdle:"idle"===t.status,mutate:this.mutate,reset:this.reset}}#n(t){n.jG.batch(()=>{if(this.#i&&this.hasListeners()){let e=this.#e.variables,s=this.#e.context,i={client:this.#t,meta:this.options.meta,mutationKey:this.options.mutationKey};if(t?.type==="success"){try{this.#i.onSuccess?.(t.data,e,s,i)}catch(t){Promise.reject(t)}try{this.#i.onSettled?.(t.data,null,e,s,i)}catch(t){Promise.reject(t)}}else if(t?.type==="error"){try{this.#i.onError?.(t.error,e,s,i)}catch(t){Promise.reject(t)}try{this.#i.onSettled?.(void 0,t.error,e,s,i)}catch(t){Promise.reject(t)}}}this.listeners.forEach(t=>{t(this.#e)})})}},o=s(7665);function c(t,e){let s=(0,o.jE)(e),[r]=i.useState(()=>new l(s,t));i.useEffect(()=>{r.setOptions(t)},[r,t]);let a=i.useSyncExternalStore(i.useCallback(t=>r.subscribe(n.jG.batchCalls(t)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),c=i.useCallback((t,e)=>{r.mutate(t,e).catch(u.lQ)},[r]);if(a.error&&(0,u.GU)(r.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}}}]);