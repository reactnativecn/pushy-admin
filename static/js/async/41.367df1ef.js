"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["41"],{6304:function(e,t,i){i.r(t),i.d(t,{AuditLogs:()=>b,Component:()=>Y,getUA:()=>S});var s=i(4848),r=i(3078),a=i(7710),d=i(8738),n=i(4042),l=i(1876),o=i(697),c=i(2894),p=i(4353),u=i.n(p),h=i(8867),m=i.n(h),f=i(8906),x=i.n(f),y=i(6279),v=i.n(y),j=i(6540),g=i(3959),O=i(1568);i(6033);var w=i(8446);let{RangePicker:A}=d.A;u().extend(v()),u().extend(m()),u().extend(x()),u().locale("zh-cn");let S=e=>{if(e.startsWith("react-native-update-cli"))return(0,s.jsxs)("div",{children:["cli ",e.split("/")[1]]});let{browser:t,os:i}=(0,w.O)(e);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{children:[t.name," ",t.version]}),(0,s.jsxs)("div",{children:[i.name," ",i.version]})]})},{Text:T}=n.A,P={"POST /user/login":"登录","POST /user/register":"注册","POST /user/activate":"激活账户","POST /user/activate/sendmail":"发送激活邮件","POST /user/resetpwd/sendmail":"发送重置密码邮件","POST /user/resetpwd/reset":"重置密码","POST /app/create":"创建应用","PUT /app/{id}":"更新应用","DELETE /app/{id}":"删除应用","POST /orders":"创建订单","POST /upload":"上传文件","POST /app/{id}/package/create":"创建原生包","PUT /app/{id}/package/{id}":"修改原生包设置","DELETE /app/{id}/package/{id}":"删除原生包","POST /app/{id}/version/create":"创建热更包","PUT /app/{id}/version/{id}":"修改热更包设置","DELETE /app/{id}/version/{id}":"删除热更包","POST /app/{id}/binding":"创建/更新绑定","DELETE /app/{id}/binding/{id}":"删除绑定","POST /api-token/create":"创建 API Key","DELETE /api-token/{id}":"删除 API Key"},E=(e,t)=>{let i=t.replace(/\/\d+/g,"/{id}").replace(/\/$/,"");return P[`${e.toUpperCase()} ${i}`]||`${e.toUpperCase()} ${t}`},k=[{title:"时间",dataIndex:"createdAt",width:180,sorter:(e,t)=>u()(e.createdAt).valueOf()-u()(t.createdAt).valueOf(),render:e=>{let t=u()(e);return(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{children:t.format("YYYY-MM-DD HH:mm:ss")}),(0,s.jsx)(T,{type:"secondary",className:"text-xs",children:t.fromNow()})]})}},{title:"操作",width:120,filters:Object.values(P).sort().map(e=>({text:e,value:e})),onFilter:(e,t)=>E(t.method,t.path)===e,render:(e,t)=>{let i=E(t.method,t.path),r="DELETE"===t.method.toUpperCase()?"#ff4d4f":void 0;return(0,s.jsx)("span",{style:r?{color:r}:void 0,children:i})}},{title:"状态码",dataIndex:"statusCode",width:100,render:e=>{let t=Number(e)>=500?"#ff4d4f":void 0;return(0,s.jsx)("span",{className:"font-medium",style:t?{color:t}:void 0,children:e})}},{title:"提交数据",width:300,ellipsis:{showTitle:!1},render:(e,t)=>{let{path:i,data:r}=t;if(i.startsWith("/upload"))if((null==r?void 0:r.ext)===".ppk")return(0,s.jsx)(T,{children:"热更包"});else return(0,s.jsx)(T,{children:"原生包"});return r?(delete r.deps,delete r.commit,(0,s.jsx)(T,{ellipsis:{tooltip:JSON.stringify(r,null,2)},children:JSON.stringify(r)})):(0,s.jsx)(T,{type:"secondary",children:"-"})}},{title:"设备信息",dataIndex:"userAgent",width:250,ellipsis:{showTitle:!1},render:(e,t)=>e||t.ip?(0,s.jsxs)("div",{title:e||t.ip,children:[e&&(0,s.jsx)("div",{children:S(e)}),t.ip&&(0,s.jsx)("div",{className:"mt-1",children:(0,s.jsxs)(T,{type:"secondary",className:"text-xs",children:["IP: ",t.ip]})})]}):(0,s.jsx)(T,{type:"secondary",children:"-"})},{title:"API Key",dataIndex:["apiTokens","tokenSuffix"],width:120,render:e=>e?(0,s.jsxs)(T,{className:"font-mono text-xs",children:["****",e]}):(0,s.jsx)(T,{type:"secondary",children:"-"})}],b=()=>{let[e,t]=(0,j.useState)(0),[i,d]=(0,j.useState)(20),[n,p]=(0,j.useState)(null),{auditLogs:h,isLoading:m}=(0,O.UJ)({offset:0,limit:1e3}),f=(0,j.useMemo)(()=>{if(!n||!n[0]&&!n[1])return h;let[e,t]=n;return h.filter(i=>{let s=u()(i.createdAt);return e&&t?s.isSameOrAfter(e.startOf("day"))&&s.isSameOrBefore(t.endOf("day")):e?s.isSameOrAfter(e.startOf("day")):!t||s.isSameOrBefore(t.endOf("day"))})},[h,n]);return(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsx)("div",{className:"mb-4",children:(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[(0,s.jsx)(r.A,{}),"操作日志"]}),(0,s.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:"日志功能从 2025 年 11 月 17 日开始测试，没有更早的数据。将仅保留 180 天内的数据。"})]}),(0,s.jsxs)(l.A,{children:[(0,s.jsx)(A,{value:n,onChange:e=>{if((null==e?void 0:e[0])&&(null==e?void 0:e[1])){let t=e[0];if(e[1].diff(t,"day")>180){let e=t.add(180,"day");p([t,e])}else p(e)}else p(e);t(0)},format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],allowClear:!0,disabledDate:e=>{if(!e)return!1;let t=u()(),i=t.subtract(180,"day");if(e.isAfter(t,"day")||e.isBefore(i,"day"))return!0;if((null==n?void 0:n[0])&&!n[1]){let t=n[0],i=t.add(180,"day");return e.isBefore(t,"day")||e.isAfter(i,"day")}if(!(null==n?void 0:n[0])&&(null==n?void 0:n[1])){let t=n[1],i=t.subtract(180,"day");return e.isAfter(t,"day")||e.isBefore(i,"day")}return!1}}),(0,s.jsx)(o.Ay,{type:"primary",icon:(0,s.jsx)(a.A,{}),onClick:()=>{if(0===f.length)return;let e=f.map(e=>{var t;let i=u()(e.createdAt),s=E(e.method,e.path),r="-",a="-";if(e.userAgent)if(e.userAgent.startsWith("react-native-update-cli")){let t=e.userAgent.split("/")[1]||"";r=`cli ${t}`.trim(),a="-"}else{let{browser:t,os:i}=(0,w.O)(e.userAgent);r=`${t.name||"-"} ${t.version||""}`.trim(),a=`${i.name||"-"} ${i.version||""}`.trim()}return{时间:i.format("YYYY-MM-DD HH:mm:ss"),操作:s,状态码:e.statusCode,提交数据:e.data?JSON.stringify(e.data):"-",浏览器:r,操作系统:a,IP地址:e.ip||"-","API Key":`****${(null==(t=e.apiTokens)?void 0:t.tokenSuffix)||"-"}`}}),t=g.Wp.book_new(),i=g.Wp.json_to_sheet(e);i["!cols"]=[{wch:20},{wch:15},{wch:10},{wch:40},{wch:20},{wch:20},{wch:15},{wch:15}],g.Wp.book_append_sheet(t,i,"操作日志");let s=`操作日志_${u()().format("YYYY-MM-DD_HH-mm-ss")}.xlsx`;g._h(t,s)},disabled:0===f.length,children:"导出 Excel"})]})]})}),(0,s.jsx)(c.A,{rowKey:"id",columns:k,dataSource:f,loading:m,pagination:{showSizeChanger:!0,showQuickJumper:!0,total:f.length,current:e/i+1,pageSize:i,showTotal:e=>`共 ${e} 条记录`,onChange(e,i){i&&(t((e-1)*i),d(i))}},scroll:{x:1200}})]})},Y=b}}]);