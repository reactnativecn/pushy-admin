"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["633"],{9160(e,t,l){l.r(t),l.d(t,{Component:()=>S});var a=l(4848),r=l(7833),s=l(2454),i=l(6287),o=l(3494),n=l(4840),u=l(3271),c=l(2061),d=l(8361),m=l(8032),p=l(4353),h=l.n(p),f=l(6540),g=l(3433),b=l(391),v=l(1568);let{Title:y}=i.A,{RangePicker:x}=o.A,w="查询热更次数",j=e=>{if(!e)return{label:"unknown",isTotal:!1};if("_total"===e||"total"===e)return{label:w,isTotal:!0};let t=e.split("\x1f");if(t.length>=2){let e=t[0],l=t.slice(1).join();if(l&&"unknown"!==l||(l="无"),"hash"===e)return{label:`热更包: ${l}`,attribute:"hash",isTotal:!1};if("packageVersion_buildTime"===e)return{label:`原生包: ${l}`,attribute:"packageVersion_buildTime",isTotal:!1}}return e.endsWith("\x1f")||e.endsWith(`\u001funknown`)?{label:e.replace("\x1f",": 无"),isTotal:!1}:{label:e.replace("\x1f",": "),isTotal:!1}},A=[{label:"热更包",value:"hash"},{label:"原生包",value:"packageVersion_buildTime"}],S=()=>{let[e,t]=(0,g.ok)(),[l,i]=(0,f.useState)([h()().subtract(24,"hour"),h()()]),[o,p]=(0,f.useState)(e.get("appKey")||void 0),[S,T]=(0,f.useState)(""),[M,k]=(0,f.useState)("hash"),K=(0,f.useRef)([]),{apps:N}=(0,v.vu)(),{user:F}=(0,v.Py)(),C=(null==F?void 0:F.admin)===!0,_=(0,f.useMemo)(()=>(N||[]).filter(e=>!!e.appKey).map(e=>({label:e.name,value:e.appKey})),[N]);(0,f.useEffect)(()=>{let t=e.get("appKey");t&&t!==o&&(C||_.some(e=>e.value===t))&&p(t)},[e,C,_,o]),(0,f.useEffect)(()=>{if(!o&&_.length>0&&!e.get("appKey")){let e=_[0].value;p(e),t({appKey:e},{replace:!0})}},[_,o,e,t]);let{data:I,isLoading:O}=(0,s.I)({queryKey:["appMetrics",o,l[0].toISOString(),l[1].toISOString()],queryFn:()=>b.F.getAppMetrics({appKey:o,start:l[0].toISOString(),end:l[1].toISOString()}),enabled:!!o&&!!l[0]&&!!l[1]}),V=(0,f.useMemo)(()=>{if(!(null==I?void 0:I.data)||!(null==I?void 0:I.dict))return[];let e=[];for(let t of I.data)for(let[l,a]of t.data){let{label:r,attribute:s,isTotal:i}=j(I.dict[l]||"");e.push({time:t.time,value:a,category:r,attribute:s,isTotal:i})}return e},[I]),D=(0,f.useMemo)(()=>V.filter(e=>e.isTotal||e.attribute===M),[V,M]),E=(0,f.useMemo)(()=>{let e=new Map;for(let t of D)t.isTotal||e.set(t.category,(e.get(t.category)||0)+t.value);return e},[D]),P=(0,f.useMemo)(()=>Array.from(E.entries()).sort((e,t)=>t[1]-e[1]).map(e=>{let[t]=e;return t}),[E]),R=(0,f.useMemo)(()=>D.some(e=>e.isTotal),[D]),q=(0,f.useMemo)(()=>{let e=P.slice(0,10);return R?[w,...e]:e},[P,R]),B=(0,f.useMemo)(()=>R?[w,...P]:P,[P,R]);K.current=q;let H={interaction:{legendFilter:!0,tooltip:{shared:!0}},data:D,xField:e=>new Date(e.time),yField:"value",colorField:"category",shapeField:"smooth",axis:{x:{title:"时间",labelAutoRotate:!0,labelFormatter:e=>{let t=h()(e);return t.isValid()?t.format("MM/DD HH:mm"):e}},y:{}},tooltip:{channel:"y"},legend:{position:"top"},scale:B.length?{color:{domain:B}}:void 0,onReady:e=>{let{chart:t}=e;try{t.on("afterrender",()=>{let e=K.current;e.length&&t.emit("legend:filter",{data:{channel:"color",values:e}})})}catch(e){console.error(e)}},height:480};return(0,a.jsx)("div",{className:"page-section",children:(0,a.jsxs)(n.A,{children:[(0,a.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6",children:[(0,a.jsx)(y,{level:4,className:"m-0!",children:"实时数据"}),(0,a.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:flex-wrap md:items-center",children:[(0,a.jsx)(u.A,{placeholder:"选择应用",showSearch:!0,optionFilterProp:"label",value:o,onChange:e=>{p(e),t({appKey:e},{replace:!0})},options:_,className:"w-full md:w-52"}),(0,a.jsx)(c.A.Group,{value:M,onChange:e=>k(e.target.value),optionType:"button",buttonStyle:"solid",className:"w-full md:w-auto",children:A.map(e=>(0,a.jsx)(c.A.Button,{value:e.value,children:e.label},e.value))}),C&&(0,a.jsx)(d.A,{placeholder:"输入任意 App Key",value:S,onChange:e=>T(e.target.value),onPressEnter:()=>{S.trim()&&(p(S.trim()),t({appKey:S.trim()},{replace:!0}),T(""))},className:"w-full md:w-44"}),(0,a.jsx)(x,{showTime:!0,value:l,onChange:e=>{(null==e?void 0:e[0])&&e[1]&&i([e[0],e[1]])},className:"w-full md:w-auto",presets:[{label:"过去1小时",value:[h()().subtract(1,"hour"),h()()]},{label:"过去6小时",value:[h()().subtract(6,"hour"),h()()]},{label:"过去24小时",value:[h()().subtract(24,"hour"),h()()]},{label:"过去7天",value:[h()().subtract(7,"day"),h()()]}]})]})]}),(0,a.jsx)(m.A,{spinning:O,children:(0,a.jsx)(n.A,{size:"small",style:{marginBottom:20},children:o?D.length>0?(0,a.jsx)(r.A,{...H}):(0,a.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"暂无数据"}):(0,a.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"请选择应用"})})})]})})}}}]);