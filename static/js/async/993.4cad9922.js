"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["993"],{9680:function(e,l,a){a.r(l),a.d(l,{Manage:()=>ej,Component:()=>ey});var s=a(4848),n=a(2700),t=a(339),i=a(6929),r=a(5207),d=a(8657),c=a(7152),o=a(6370),m=a(4914),x=a(6248),u=a(8284),h=a(6677),p=a(9312),j=a(6700),y=a(8388),A=a(5625),g=a(6540),v=a(4824),f=a(9499),k=a(584),b=a(8129),N=a(9100),C=a(192);let I=(0,g.createContext)({appId:0,deepLink:"",setDeepLink:()=>{},packages:[],unusedPackages:[]}),w=()=>(0,g.useContext)(I),$=e=>{let{children:l,appId:a}=e,[n,t]=(0,g.useState)(window.localStorage.getItem(`${a}_deeplink`)??""),{packages:i=[],unusedPackages:r=[],isLoading:d}=(0,A.xi)(a),c=(0,g.useMemo)(()=>({appId:a,deepLink:n,setDeepLink:t,packages:i,unusedPackages:r,packagesLoading:d}),[a,n,i,r,d]);return(0,s.jsx)(I.Provider,{value:c,children:l})};var F=a(9951),S=a(4353),P=a.n(S),D=a(3605),V=a.n(D),O=a(4942);let _=e=>{let{commit:l}=e;if(!l)return(0,s.jsx)(F.A,{className:"ant-typography-edit",content:(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"text-center my-1 mx-auto",children:[(0,s.jsx)("div",{className:"font-bold",children:"最近的提交："}),(0,s.jsx)("div",{className:"text-gray-500",children:"需要使用 cli v1.42.0+ 版本上传，且使用 git 管理代码才能查看提交记录"})]})}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(O.A,{}),onClick:()=>{}})});let{origin:a,hash:n,message:t,author:i}=l,r="";if(a)try{let{owner:e,name:l,source:s}=V()(a);r=`https://${s}/${e}/${l}/commit/${n}`}catch(e){console.error(e)}let d=P()(1e3*l.timestamp);return(0,s.jsx)(F.A,{className:"ant-typography-edit",content:(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"my-1 mx-auto",children:[(0,s.jsx)("div",{className:"font-bold",children:"最近的提交："}),(0,s.jsxs)("div",{children:["作者：",i]}),(0,s.jsxs)("div",{children:["时间：",d.fromNow(),"（",d.format("YYYY-MM-DD HH:mm:ss"),"）"]}),(0,s.jsxs)("div",{children:["摘要：",t]}),(0,s.jsx)("hr",{}),r?(0,s.jsx)("a",{className:"text-xs",href:r,target:"_blank",rel:"noreferrer",children:n}):(0,s.jsx)("span",{className:"text-xs",children:n})]})}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(O.A,{}),onClick:()=>{}})})};var T=a(3964),E=a(5307),M=a(8389),B=a(6777);function K(e){let{className:l,...a}=e,n=(0,g.useRef)(null),t=(0,g.useRef)(null);return(0,g.useEffect)(()=>(t.current=(0,B._j)({target:n.current,props:{mode:B.Kt.text,...a}}),()=>{t.current&&t.current.destroy()}),[]),(0,g.useEffect)(()=>{var e;null==(e=t.current)||e.updateProps(a)},[a]),(0,s.jsx)("div",{className:l,ref:n})}var L=a(4565),z=a(8231);a(3115);let H=new L.A({detectCircular:!0,maxDepth:1/0,showModifications:!0,arrayDiffMethod:"lcs"}),Y=e=>{let{oldDeps:l,newDeps:a}=e;if(!l||!a)return null;let n=H.diff(l,a);return(0,s.jsx)(z.A,{diff:n,highlightInlineDiff:!0})},R=e=>{let{deps:l,name:a}=e,{packages:n,appId:t}=w(),{allVersions:i}=(0,A.jh)({appId:t}),[r,d]=(0,g.useState)(null);return(0,s.jsx)(F.A,{className:"ant-typography-edit",afterOpenChange:e=>{e||d(null)},content:(0,s.jsx)("div",{children:(0,s.jsx)("div",{className:"text-center my-1 mx-auto",children:l?(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,s.jsxs)("div",{className:"h-12",children:[(0,s.jsxs)("div",{className:"font-bold",children:["JavaScript 依赖列表",!r&&`(${a})`,(0,s.jsx)("div",{children:r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:"font-normal",children:r.newName}),` <-> ${a}`]})})]}),(0,s.jsx)("div",{className:"absolute right-3 top-3",children:r?(0,s.jsx)(h.Ay,{className:"content-end",onClick:()=>{d(null)},children:"返回"}):(0,s.jsx)(M.A,{menu:{items:[{key:"package",type:"group",label:"原生包",children:n.filter(e=>!!e.deps).map(e=>({key:`p_${e.id}`,label:e.name}))},{key:"version",type:"group",label:"热更包",children:i.filter(e=>!!e.deps).map(e=>({key:`v_${e.id}`,label:e.name}))}],onClick:e=>{let{key:a}=e,[s,t]=a.split("_");if("p"===s){let e=n.find(e=>e.id===+t);d({oldDeps:null==e?void 0:e.deps,newDeps:l,newName:"原生包 "+(null==e?void 0:e.name)})}else{let e=i.find(e=>e.id===+t);d({oldDeps:null==e?void 0:e.deps,newDeps:l,newName:"热更包 "+(null==e?void 0:e.name)})}}},children:(0,s.jsxs)(h.Ay,{children:["对比变更",(0,s.jsx)(T.A,{})]})})})]}),(0,s.jsx)("div",{className:"max-h-[50vh] overflow-y-auto",children:r?(0,s.jsx)(Y,{oldDeps:r.oldDeps,newDeps:r.newDeps}):(0,s.jsx)(K,{content:{json:Object.keys(l).sort().reduce((e,a)=>(e[a]=l[a],e),{})},mode:B.Kt.tree,mainMenuBar:!1,statusBar:!1,readOnly:!0})}),(0,s.jsxs)("div",{className:"text-gray-500 my-4",children:["仅在",(0,s.jsx)("span",{className:"font-bold underline",children:"上传"}),"时抓取package.json的直接依赖， 不保证严格匹配包内容，仅供参考。"]})]})}):(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"JavaScript 依赖列表"}),(0,s.jsx)("div",{className:"text-gray-500",children:"需要使用 cli v1.42.0+ 版本上传才能查看依赖列表"})]})})}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(E.A,{}),onClick:()=>{}})})},U=e=>{let{dataSource:l,loading:a}=e;return(0,s.jsx)(k.A,{loading:a,className:"packages",size:"small",dataSource:l,renderItem:e=>(0,s.jsx)(J,{item:e})})},J=e=>{let{item:l}=e,{appId:a}=w();return(0,s.jsx)("div",{className:"bg-white my-0 [&_li]:!px-0",children:(0,s.jsx)(k.A.Item,{className:"p-2",children:(0,s.jsx)(k.A.Item.Meta,{title:(0,s.jsxs)(c.A,{align:"middle",children:[(0,s.jsxs)(o.A,{flex:1,children:[l.name,l.status&&"normal"!==l.status&&(0,s.jsx)(x.A,{className:"ml-2",children:W[l.status]})]}),(0,s.jsx)(R,{deps:l.deps,name:"原生包 "+l.name}),(0,s.jsx)(_,{commit:l.commit}),(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(v.A,{}),onClick:()=>(function(e,l){let{note:a,status:n}=e;r.A.confirm({icon:null,closable:!0,maskClosable:!0,content:(0,s.jsxs)(d.A,{layout:"vertical",initialValues:e,children:[(0,s.jsx)(d.A.Item,{name:"note",label:"备注",children:(0,s.jsx)(b.A,{placeholder:"添加原生包备注",onChange:e=>{let{target:l}=e;return a=l.value}})}),(0,s.jsx)(d.A.Item,{name:"status",label:"状态",children:(0,s.jsxs)(N.A,{onSelect:e=>{n=e},children:[(0,s.jsx)(N.A.Option,{value:"normal",children:"正常"}),(0,s.jsx)(N.A.Option,{value:"paused",children:"暂停"}),(0,s.jsx)(N.A.Option,{value:"expired",children:"过期"})]})})]}),async onOk(){await y.F.updatePackage({appId:l,packageId:e.id,params:{note:a,status:n}})}})})(l,a)}),(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(f.A,{}),onClick:()=>{r.A.confirm({title:`删除后无法恢复，确定删除原生包“${l.name}”？`,maskClosable:!0,okButtonProps:{danger:!0},async onOk(){await y.F.deletePackage({appId:a,packageId:l.id})}})},danger:!0})]}),description:(0,s.jsxs)("div",{children:[l.note&&(0,s.jsxs)(C.A.Paragraph,{className:"mb-0",type:"secondary",ellipsis:{tooltip:l.note},children:["备注：",l.note]}),(0,s.jsx)("div",{className:"text-xs flex flex-col gap-1",children:(0,s.jsxs)("div",{children:["编译时间：",l.buildTime]})})]})})})})},W={paused:"暂停",expired:"过期"};var Q=a(3909),q=a(9405),G=a(7639);let X=()=>{let{user:e}=(0,A.Py)(),{appId:l}=w(),a=d.A.useWatch("appKey"),n=d.A.useWatch("ignoreBuildTime");return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(d.A.Item,{label:"AppId",layout:"vertical",children:(0,s.jsx)(C.A.Paragraph,{className:"!mb-0",type:"secondary",copyable:!0,children:l})}),(0,s.jsx)(d.A.Item,{label:"AppKey",name:"appKey",layout:"vertical",children:(0,s.jsx)(C.A.Paragraph,{className:"!mb-0",type:"secondary",copyable:!0,children:a})}),(0,s.jsx)(d.A.Item,{label:"应用名",name:"name",layout:"vertical",children:(0,s.jsx)(b.A,{})}),(0,s.jsx)(d.A.Item,{label:"原生包下载地址（当用户端的原生版本过期时，会使用此地址下载）",name:"downloadUrl",layout:"vertical",children:(0,s.jsx)(b.A,{})}),(0,s.jsx)(d.A.Item,{layout:"vertical",label:"启用热更新",name:"status",normalize:e=>e?"normal":"paused",getValueProps:e=>({value:"normal"===e||null==e}),children:(0,s.jsx)(G.A,{checkedChildren:"已启用",unCheckedChildren:"已暂停"})}),(0,s.jsx)(d.A.Item,{layout:"vertical",label:"忽略编译时间戳（高级版以上可启用）",name:"ignoreBuildTime",normalize:e=>e?"enabled":"disabled",getValueProps:e=>({value:"enabled"===e}),children:(0,s.jsx)(G.A,{disabled:((null==e?void 0:e.tier)==="free"||(null==e?void 0:e.tier)==="standard")&&"enabled"!==n,checkedChildren:"已启用",unCheckedChildren:"已禁用"})}),(0,s.jsx)(d.A.Item,{label:"删除应用",layout:"vertical",children:(0,s.jsx)(h.Ay,{type:"primary",icon:(0,s.jsx)(q.A,{}),onClick:()=>{r.A.confirm({title:"应用删除后无法恢复",okText:"确认删除",okButtonProps:{danger:!0},async onOk(){await y.F.deleteApp(l),r.A.destroyAll(),Q.QB.navigate(Q.DQ.apps)}})},danger:!0,children:"删除"})})]})};var Z=a(7280),ee=a(8274),el=a(464),ea=a(3577),es=a(1476),en=a(7698),et=a(519),ei=a(2675),er=a(2258),ed=a(2816);let ec=e=>{let{packages:l,versionId:a,config:n}=e,{packages:t,appId:i}=w(),r=t.filter(e=>!l.some(l=>e.id===l.id)),d=l.map(e=>{var l;let t=null==n||null==(l=n.rollout)?void 0:l[e.name],r=100===t||null==t,d=Number(t),c={items:r?[]:[{key:"full",label:"全量",icon:(0,s.jsx)(et.A,{}),onClick:()=>{y.F.updateVersion({appId:i,versionId:a,params:{config:{rollout:{[e.name]:null}}}}),y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:a}})}}]};d<50&&!r&&c.items.push({key:"gray",label:"灰度",icon:(0,s.jsx)(ei.A,{}),onClick:()=>y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:a}}),children:[1,2,5,10,20,50].filter(e=>e>d).map(l=>({key:`${l}`,label:`${l}%`,onClick:()=>y.F.updateVersion({appId:i,versionId:a,params:{config:{rollout:{[e.name]:l}}}})}))}),c.items.length>0&&c.items.push({type:"divider"}),c.items.push({key:"unpublish",label:"取消绑定",icon:(0,s.jsx)(er.A,{}),onClick:()=>{y.F.updateVersion({appId:i,versionId:a,params:{config:{rollout:{[e.name]:null}}}}),y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:null}})}});let o=(0,s.jsxs)(h.Ay,{size:"small",color:"primary",variant:r?"filled":"dashed",children:[(0,s.jsx)("span",{className:"font-bold",children:e.name}),(0,s.jsx)("span",{className:"text-xs",children:r?"":`(${t}%)`})]});return(0,s.jsx)(M.A,{menu:c,children:o},e.id)});return(0,s.jsxs)("div",{className:"flex flex-wrap gap-1",children:[d,0!==r.length&&(0,s.jsx)(M.A,{menu:{items:r.map(e=>({key:e.id,label:e.name,onClick:()=>y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:a}}),children:[{key:"full",label:"全量",icon:(0,s.jsx)(et.A,{}),onClick:()=>y.F.updateVersion({appId:i,versionId:a,params:{config:{rollout:{[e.name]:null}}}})},{key:"gray",label:"灰度",icon:(0,s.jsx)(ei.A,{}),children:[1,2,5,10,20,50].map(l=>({key:`${l}`,label:`${l}%`,onClick:()=>y.F.updateVersion({appId:i,versionId:a,params:{config:{rollout:{[e.name]:l}}}})}))}]}))},className:"ant-typography-edit",children:(0,s.jsx)(h.Ay,{type:"link",size:"small",icon:(0,s.jsx)(ed.A,{}),children:"绑定"})})]})},eo=e=>{let{name:l,hash:a}=e,{appId:n,deepLink:t,setDeepLink:i}=w(),[r,d]=(0,g.useState)(!!t),c=r&&t.endsWith("://");(0,g.useEffect)(()=>{c&&window.localStorage.setItem(`${n}_deeplink`,t)},[n,t,c]);let o={type:"__rnPushyVersionHash",data:a},m=c?`${t}?${new URLSearchParams(o).toString()}`:JSON.stringify(o);return(0,s.jsx)(F.A,{className:"ant-typography-edit",content:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"text-center my-2 mx-auto",children:["测试二维码 ",(0,s.jsx)("br",{}),(0,s.jsx)("a",{target:"_blank",className:"ml-1 text-xs",href:Z.c,rel:"noreferrer",children:"如何使用？"})]}),(0,s.jsx)("div",{className:"flex justify-center",children:(0,s.jsx)(ea.A,{value:m,bordered:!1})}),(0,s.jsx)("div",{className:"text-center my-2 mx-auto",children:l}),(0,s.jsxs)("div",{children:[(0,s.jsx)(b.A.TextArea,{readOnly:!0,autoSize:!0,value:m,className:"mb-2!"}),(0,s.jsxs)("div",{className:"flex flex-row items-center",children:[(0,s.jsx)(es.A,{className:"mr-4",checked:r,onChange:e=>{let{target:l}=e;d(l.checked)},children:"使用 Deep Link："}),(0,s.jsx)(b.A,{placeholder:"例如 pushy://",className:"flex-1",value:t,onChange:e=>{let{target:l}=e;i(l.value)}})]})]})]}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(ee.A,{}),onClick:()=>{}})})},em=[{title:"版本",dataIndex:"name",render:(e,l)=>(0,s.jsx)(ex,{record:l,recordKey:"name",extra:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(R,{deps:l.deps,name:"热更包 "+l.name}),(0,s.jsx)(_,{commit:l.commit}),(0,s.jsx)(eo,{name:l.name,hash:l.hash})]})})},{title:"描述",dataIndex:"description",render:(e,l)=>(0,s.jsx)(ex,{record:l,recordKey:"description"})},{title:"自定义元信息",dataIndex:"metaInfo",render:(e,l)=>(0,s.jsx)(ex,{record:l,recordKey:"metaInfo"})},{title:(0,s.jsxs)(F.A,{content:(0,s.jsxs)(s.Fragment,{children:["灰度发布测试中，需要 pushy 版本 v10.15.0 +。",(0,s.jsx)("br",{}),"低于此版本的只能全量发布。",(0,s.jsx)("br",{}),"取消绑定不会导致已更新的用户回滚。"]}),children:["绑定原生包 ",(0,s.jsx)(el.A,{})]}),dataIndex:"packages",width:"100%",render:(e,l)=>{let{packages:a=[],id:n,config:t}=l;return(0,s.jsx)(ec,{config:t,packages:a,versionId:n})}},{title:"上传时间",dataIndex:"createdAt",render:(e,l)=>(0,s.jsx)(ex,{record:l,recordKey:"createdAt",isEditable:!1})}],ex=e=>{let{record:l,recordKey:a,isEditable:n=!0,extra:t}=e,{appId:i}=w(),d=l[a];if("createdAt"===a){let e=new Date(d),l=e.getFullYear(),a=e.getMonth()+1,s=a<10?`0${a}`:a,n=10>e.getDate()?`0${e.getDate()}`:e.getDate(),t=10>e.getHours()?`0${e.getHours()}`:e.getHours(),i=10>e.getMinutes()?`0${e.getMinutes()}`:e.getMinutes();d=`${l}-${s}-${n} ${t}:${i}`}let c=null;return n&&(c={editing:!1,onStart(){var e;let n=d;r.A.confirm({icon:null,width:"metaInfo"===a?640:void 0,title:null==(e=em.find(e=>e.dataIndex===a))?void 0:e.title,closable:!0,maskClosable:!0,content:"metaInfo"===a?(0,s.jsx)(K,{className:"h-96",content:{text:d??""},onChange:e=>{d=e.text}}):(0,s.jsx)(b.A.TextArea,{defaultValue:d,onChange:e=>{let{target:l}=e;d=l.value}}),async onOk(){n=d,await y.F.updateVersion({appId:i,versionId:l.id,params:{[a]:d}})},async onCancel(){d=n}})}}),(0,s.jsxs)("div",{children:[(0,s.jsx)(C.A.Text,{className:"w-40",editable:c,ellipsis:!0,children:d}),t]})};function eu(){let{appId:e}=w(),[l,a]=(0,g.useState)([]),[n,t]=(0,g.useState)(0),[i,d]=(0,g.useState)(10),{versions:c,count:o,isLoading:m}=(0,A.jh)({appId:e,offset:n,limit:i});return(0,s.jsx)(en.A,{className:"versions",rowKey:"id",title:()=>"热更新包",columns:em,dataSource:c,pagination:{showSizeChanger:!0,total:o,current:n/i+1,pageSize:i,showTotal:e=>`共 ${e} 个 `,onChange(e,l){l&&(t((e-1)*l),d(l))}},rowSelection:{selections:[en.A.SELECTION_ALL,en.A.SELECTION_INVERT,en.A.SELECTION_NONE],onChange:e=>a(e)},loading:m,footer:l.length?()=>(0,s.jsx)(h.Ay,{onClick:()=>(function(e){let{selected:l,versions:a,appId:s}=e,n=[];for(let e of a)l.includes(e.id)&&n.push(e.name);r.A.confirm({title:"删除所选热更新包：",content:n.join("，"),maskClosable:!0,okButtonProps:{danger:!0},async onOk(){await Promise.all(l.map(e=>y.F.deleteVersion({appId:s,versionId:e})))}})})({selected:l,versions:c,appId:e}),danger:!0,children:"删除"}):void 0})}var eh=a(2437);let ep=()=>{let{packages:e,unusedPackages:l,packagesLoading:a}=w();return(0,s.jsxs)(t.A,{children:[(0,s.jsxs)(t.A.Sider,{theme:"light",className:"p-4 pt-0 mr-4 h-full rounded-lg",width:240,children:[(0,s.jsx)("div",{className:"py-4",children:"原生包"}),(0,s.jsxs)(i.A,{children:[(0,s.jsx)(i.A.TabPane,{tab:"全部",children:(0,s.jsx)(U,{dataSource:e,loading:a})},"all"),(0,s.jsx)(i.A.TabPane,{tab:"未使用",children:(0,s.jsx)(U,{dataSource:l,loading:a})},"unused")]})]}),(0,s.jsx)(t.A.Content,{className:"!p-0",children:(0,s.jsx)(eu,{})})]})},ej=()=>{let[e,l]=r.A.useModal(),a=Number((0,j.g)().id),{app:t}=(0,A.nm)(a),[i]=d.A.useForm();return(0,g.useEffect)(()=>{t&&i.setFieldsValue(t)},[t,i]),(0,s.jsxs)(d.A,{layout:"vertical",form:i,initialValues:t,children:[(0,s.jsxs)(c.A,{className:"mb-4",children:[(0,s.jsx)(o.A,{flex:1,children:(0,s.jsxs)(m.A,{children:[(0,s.jsx)(m.A.Item,{children:(0,s.jsx)(j.N_,{to:"/apps",children:"应用列表"})}),(0,s.jsxs)(m.A.Item,{children:[(0,s.jsx)(eh.A,{platform:null==t?void 0:t.platform,className:"mr-1"}),null==t?void 0:t.name,(null==t?void 0:t.status)==="paused"&&(0,s.jsx)(x.A,{className:"ml-2",children:"暂停"})]})]})}),(0,s.jsx)(u.A.Compact,{children:(0,s.jsx)(h.Ay,{type:"primary",icon:(0,s.jsx)(n.A,{}),onClick:()=>{e.confirm({icon:null,closable:!0,maskClosable:!0,content:(0,s.jsx)(X,{}),async onOk(){try{await y.F.updateApp(a,{name:i.getFieldValue("name"),downloadUrl:i.getFieldValue("downloadUrl"),status:i.getFieldValue("status"),ignoreBuildTime:i.getFieldValue("ignoreBuildTime")})}catch(e){p.Ay.error(e.message);return}p.Ay.success("修改成功")}})},children:"应用设置"})})]}),(0,s.jsxs)($,{appId:a,children:[l,(0,s.jsx)(ep,{})]})]})},ey=ej}}]);