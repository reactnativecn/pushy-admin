"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["41"],{6304:function(e,t,s){s.r(t),s.d(t,{AuditLogs:()=>N,Component:()=>k,getUA:()=>O});var r=s(4848),i=s(3078),n=s(7710),a=s(8738),d=s(4042),l=s(1876),o=s(697),c=s(2894),p=s(4353),u=s.n(p),h=s(8867),f=s.n(h),m=s(8906),x=s.n(m),y=s(6279),v=s.n(y),j=s(6540),g=s(3959),A=s(1568);s(6033);var w=s(8446);let{RangePicker:S}=a.A;u().extend(v()),u().extend(f()),u().extend(x()),u().locale("zh-cn");let O=e=>{if(e.startsWith("react-native-update-cli"))return(0,r.jsxs)("div",{children:["cli ",e.split("/")[1]]});let{browser:t,os:s}=(0,w.O)(e);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[t.name," ",t.version]}),(0,r.jsxs)("div",{children:[s.name," ",s.version]})]})},{Text:T}=d.A,P={"POST /user/login":"登录","POST /user/register":"注册","POST /user/activate":"激活账户","POST /user/activate/sendmail":"发送激活邮件","POST /user/resetpwd/sendmail":"发送重置密码邮件","POST /user/resetpwd/reset":"重置密码","POST /app/create":"创建应用","POST /orders":"创建订单","POST /upload":"上传文件"},$=[{pattern:/^\/app\/\d+\/package\/\d+$/,getAction:e=>"PUT"===e?"修改原生包设置":"DELETE"===e?"删除原生包":""},{pattern:/^\/app\/\d+\/version\/\d+$/,getAction:e=>"PUT"===e?"修改热更包设置":"DELETE"===e?"删除热更包":"POST"===e?"创建热更包":""},{pattern:/^\/app\/\d+\/binding\/$/,getAction:()=>"创建/更新绑定"},{pattern:/^\/app\/\d+\/binding\/\d+$/,getAction:()=>"删除绑定"},{pattern:/^\/app\/\d+$/,getAction:e=>"PUT"===e?"更新应用":"DELETE"===e?"删除应用":""}],Y=(e,t)=>{let s=`${e.toUpperCase()} ${t}`;if(P[s])return P[s];for(let{pattern:s,getAction:r}of $)if(s.test(t))return r(e.toUpperCase());return`${e.toUpperCase()} ${t}`},b=[{title:"时间",dataIndex:"createdAt",width:180,sorter:!0,render:e=>{let t=u()(e);return(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{children:t.format("YYYY-MM-DD HH:mm:ss")}),(0,r.jsx)(T,{type:"secondary",className:"text-xs",children:t.fromNow()})]})}},{title:"操作",width:120,render:(e,t)=>{let s=Y(t.method,t.path),i="DELETE"===t.method.toUpperCase()?"#ff4d4f":void 0;return(0,r.jsx)("span",{style:i?{color:i}:void 0,children:s})}},{title:"状态码",dataIndex:"statusCode",width:100,render:e=>{let t=Number(e)>=500?"#ff4d4f":void 0;return(0,r.jsx)("span",{className:"font-medium",style:t?{color:t}:void 0,children:e})}},{title:"提交数据",width:300,ellipsis:{showTitle:!1},render:(e,t)=>{let{path:s,data:i}=t;if(s.startsWith("/upload"))if((null==i?void 0:i.ext)===".ppk")return(0,r.jsx)(T,{children:"热更包"});else return(0,r.jsx)(T,{children:"原生包"});return i?(0,r.jsx)(T,{ellipsis:{tooltip:JSON.stringify(i,null,2)},children:JSON.stringify(i)}):(0,r.jsx)(T,{type:"secondary",children:"-"})}},{title:"设备信息",dataIndex:"userAgent",width:250,ellipsis:{showTitle:!1},render:(e,t)=>e||t.ip?(0,r.jsxs)("div",{title:e||t.ip,children:[e&&(0,r.jsx)("div",{children:O(e)}),t.ip&&(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsxs)(T,{type:"secondary",className:"text-xs",children:["IP: ",t.ip]})})]}):(0,r.jsx)(T,{type:"secondary",children:"-"})},{title:"API Key",dataIndex:["apiTokens","tokenSuffix"],width:120,render:e=>e?(0,r.jsxs)(T,{className:"font-mono text-xs",children:["****",e]}):(0,r.jsx)(T,{type:"secondary",children:"-"})}],N=()=>{let[e,t]=(0,j.useState)(0),[s,a]=(0,j.useState)(20),[d,p]=(0,j.useState)(null),{auditLogs:h,isLoading:f}=(0,A.UJ)({offset:0,limit:1e3}),m=(0,j.useMemo)(()=>{if(!d||!d[0]&&!d[1])return h;let[e,t]=d;return h.filter(s=>{let r=u()(s.createdAt);return e&&t?r.isSameOrAfter(e.startOf("day"))&&r.isSameOrBefore(t.endOf("day")):e?r.isSameOrAfter(e.startOf("day")):!t||r.isSameOrBefore(t.endOf("day"))})},[h,d]),x=(0,j.useMemo)(()=>{let t=e+s;return m.slice(e,t)},[m,e,s]);return(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("div",{className:"mb-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[(0,r.jsx)(i.A,{}),"操作日志"]}),(0,r.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:"日志功能从 2025 年 11 月 17 日开始测试，没有更早的数据。将仅保留 180 天内的数据。"})]}),(0,r.jsxs)(l.A,{children:[(0,r.jsx)(S,{value:d,onChange:e=>{if((null==e?void 0:e[0])&&(null==e?void 0:e[1])){let t=e[0];if(e[1].diff(t,"day")>180){let e=t.add(180,"day");p([t,e])}else p(e)}else p(e);t(0)},format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],allowClear:!0,disabledDate:e=>{if(!e)return!1;let t=u()(),s=t.subtract(180,"day");if(e.isAfter(t,"day")||e.isBefore(s,"day"))return!0;if((null==d?void 0:d[0])&&!d[1]){let t=d[0],s=t.add(180,"day");return e.isBefore(t,"day")||e.isAfter(s,"day")}if(!(null==d?void 0:d[0])&&(null==d?void 0:d[1])){let t=d[1],s=t.subtract(180,"day");return e.isAfter(t,"day")||e.isBefore(s,"day")}return!1}}),(0,r.jsx)(o.Ay,{type:"primary",icon:(0,r.jsx)(n.A,{}),onClick:()=>{if(0===m.length)return;let e=m.map(e=>{var t;let s=u()(e.createdAt),r=Y(e.method,e.path),i="-",n="-";if(e.userAgent)if(e.userAgent.startsWith("react-native-update-cli")){let t=e.userAgent.split("/")[1]||"";i=`cli ${t}`.trim(),n="-"}else{let{browser:t,os:s}=(0,w.O)(e.userAgent);i=`${t.name||"-"} ${t.version||""}`.trim(),n=`${s.name||"-"} ${s.version||""}`.trim()}return{时间:s.format("YYYY-MM-DD HH:mm:ss"),操作:r,状态码:e.statusCode,提交数据:e.data?JSON.stringify(e.data):"-",浏览器:i,操作系统:n,IP地址:e.ip||"-","API Key":`****${(null==(t=e.apiTokens)?void 0:t.tokenSuffix)||"-"}`}}),t=g.Wp.book_new(),s=g.Wp.json_to_sheet(e);s["!cols"]=[{wch:20},{wch:15},{wch:10},{wch:40},{wch:20},{wch:20},{wch:15},{wch:15}],g.Wp.book_append_sheet(t,s,"操作日志");let r=`操作日志_${u()().format("YYYY-MM-DD_HH-mm-ss")}.xlsx`;g._h(t,r)},disabled:0===m.length,children:"导出 Excel"})]})]})}),(0,r.jsx)(c.A,{rowKey:"id",columns:b,dataSource:x,loading:f,pagination:{showSizeChanger:!0,showQuickJumper:!0,total:m.length,current:e/s+1,pageSize:s,showTotal:e=>`共 ${e} 条记录`,onChange(e,s){s&&(t((e-1)*s),a(s))}},scroll:{x:1200}})]})},k=N}}]);