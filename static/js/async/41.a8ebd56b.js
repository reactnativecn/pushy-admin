"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["41"],{6304:function(e,t,s){s.r(t),s.d(t,{AuditLogs:()=>$,Component:()=>C,getUA:()=>O});var r=s(4848),i=s(3078),n=s(7710),a=s(8738),d=s(4042),l=s(1876),o=s(697),c=s(2894),p=s(4353),h=s.n(p),u=s(8867),f=s.n(u),m=s(8906),x=s.n(m),y=s(6279),v=s.n(y),j=s(6540),g=s(3959),w=s(1568);s(6033);var A=s(8446);let{RangePicker:S}=a.A;h().extend(v()),h().extend(f()),h().extend(x()),h().locale("zh-cn");let O=e=>{let{browser:t,os:s}=(0,A.O)(e);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[t.name," ",t.version]}),(0,r.jsxs)("div",{children:[s.name," ",s.version]})]})},{Text:T}=d.A,Y={"POST /user/login":"登录","POST /user/register":"注册","POST /user/activate":"激活账户","POST /user/activate/sendmail":"发送激活邮件","POST /user/resetpwd/sendmail":"发送重置密码邮件","POST /user/resetpwd/reset":"重置密码","POST /app/create":"创建应用","POST /orders":"创建订单"},b=[{pattern:/^\/app\/\d+$/,getAction:e=>"PUT"===e?"更新应用":"DELETE"===e?"删除应用":""},{pattern:/^\/app\/\d+\/package\/\d+$/,getAction:e=>"PUT"===e?"更新原生包":"DELETE"===e?"删除原生包":""},{pattern:/^\/app\/\d+\/version\/\d+$/,getAction:e=>"PUT"===e?"更新热更新包":"DELETE"===e?"删除热更新包":""},{pattern:/^\/app\/\d+\/binding\/$/,getAction:()=>"创建/更新绑定"},{pattern:/^\/app\/\d+\/binding\/\d+$/,getAction:()=>"删除绑定"}],N=(e,t)=>{let s=`${e.toUpperCase()} ${t}`;if(Y[s])return Y[s];for(let{pattern:s,getAction:r}of b)if(s.test(t))return r(e.toUpperCase());return`${e.toUpperCase()} ${t}`},P=[{title:"时间",dataIndex:"createdAt",width:180,sorter:!0,render:e=>{let t=h()(e);return(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{children:t.format("YYYY-MM-DD HH:mm:ss")}),(0,r.jsx)(T,{type:"secondary",className:"text-xs",children:t.fromNow()})]})}},{title:"操作",width:120,render:(e,t)=>{let s=N(t.method,t.path),i="DELETE"===t.method.toUpperCase()?"#ff4d4f":void 0;return(0,r.jsx)("span",{style:i?{color:i}:void 0,children:s})}},{title:"状态码",dataIndex:"statusCode",width:100,render:e=>{let t=Number(e)>=500?"#ff4d4f":void 0;return(0,r.jsx)("span",{className:"font-medium",style:t?{color:t}:void 0,children:e})}},{title:"提交数据",dataIndex:"data",width:300,ellipsis:{showTitle:!1},render:e=>e?(0,r.jsx)(T,{ellipsis:{tooltip:JSON.stringify(e,null,2)},children:JSON.stringify(e)}):(0,r.jsx)(T,{type:"secondary",children:"-"})},{title:"设备信息",dataIndex:"userAgent",width:250,ellipsis:{showTitle:!1},render:(e,t)=>e||t.ip?(0,r.jsxs)("div",{title:e||t.ip,children:[e&&(0,r.jsx)("div",{children:O(e)}),t.ip&&(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsxs)(T,{type:"secondary",className:"text-xs",children:["IP: ",t.ip]})})]}):(0,r.jsx)(T,{type:"secondary",children:"-"})},{title:"是否使用 API",dataIndex:["apiTokens","tokenSuffix"],width:120,render:e=>e?(0,r.jsx)(T,{className:"font-mono text-xs",children:e}):(0,r.jsx)(T,{type:"secondary",children:"-"})}],$=()=>{let[e,t]=(0,j.useState)(0),[s,a]=(0,j.useState)(20),[d,p]=(0,j.useState)(null),{auditLogs:u,isLoading:f}=(0,w.UJ)({offset:0,limit:1e3}),m=(0,j.useMemo)(()=>{if(!d||!d[0]&&!d[1])return u;let[e,t]=d;return u.filter(s=>{let r=h()(s.createdAt);return e&&t?r.isSameOrAfter(e.startOf("day"))&&r.isSameOrBefore(t.endOf("day")):e?r.isSameOrAfter(e.startOf("day")):!t||r.isSameOrBefore(t.endOf("day"))})},[u,d]),x=(0,j.useMemo)(()=>{let t=e+s;return m.slice(e,t)},[m,e,s]);return(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("div",{className:"mb-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[(0,r.jsx)(i.A,{}),"操作日志"]}),(0,r.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:"日志功能从 2025 年 11 月 17 日开始测试，没有更早的数据。将仅保留一年内的数据。"})]}),(0,r.jsxs)(l.A,{children:[(0,r.jsx)(S,{value:d,onChange:e=>{if((null==e?void 0:e[0])&&(null==e?void 0:e[1])){let t=e[0];if(e[1].diff(t,"day")>365){let e=t.add(365,"day");p([t,e])}else p(e)}else p(e);t(0)},format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],allowClear:!0,disabledDate:e=>{if(!e)return!1;let t=h()(),s=t.subtract(1,"year");if(e.isAfter(t,"day")||e.isBefore(s,"day"))return!0;if((null==d?void 0:d[0])&&!d[1]){let t=d[0],s=t.add(1,"year");return e.isBefore(t,"day")||e.isAfter(s,"day")}if(!(null==d?void 0:d[0])&&(null==d?void 0:d[1])){let t=d[1],s=t.subtract(1,"year");return e.isAfter(t,"day")||e.isBefore(s,"day")}return!1}}),(0,r.jsx)(o.Ay,{type:"primary",icon:(0,r.jsx)(n.A,{}),onClick:()=>{if(0===m.length)return;let e=m.map(e=>{var t;let s=h()(e.createdAt),r=N(e.method,e.path),i="-",n="-";if(e.userAgent){let{browser:t,os:s}=(0,A.O)(e.userAgent);i=`${t.name||"-"} ${t.version||""}`.trim(),n=`${s.name||"-"} ${s.version||""}`.trim()}return{时间:s.format("YYYY-MM-DD HH:mm:ss"),操作:r,状态码:e.statusCode,提交数据:e.data?JSON.stringify(e.data):"-",浏览器:i,操作系统:n,IP地址:e.ip||"-",是否使用API:(null==(t=e.apiTokens)?void 0:t.tokenSuffix)||"-"}}),t=g.Wp.book_new(),s=g.Wp.json_to_sheet(e);s["!cols"]=[{wch:20},{wch:15},{wch:10},{wch:40},{wch:20},{wch:20},{wch:15},{wch:15}],g.Wp.book_append_sheet(t,s,"操作日志");let r=`操作日志_${h()().format("YYYY-MM-DD_HH-mm-ss")}.xlsx`;g._h(t,r)},disabled:0===m.length,children:"导出 Excel"})]})]})}),(0,r.jsx)(c.A,{rowKey:"id",columns:P,dataSource:x,loading:f,pagination:{showSizeChanger:!0,showQuickJumper:!0,total:m.length,current:e/s+1,pageSize:s,showTotal:e=>`共 ${e} 条记录`,onChange(e,s){s&&(t((e-1)*s),a(s))}},scroll:{x:1200}})]})},C=$}}]);