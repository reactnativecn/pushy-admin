"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["41"],{6304(e,t,s){s.r(t),s.d(t,{AuditLogs:()=>E,Component:()=>N,getUA:()=>T});var i=s(4848),r=s(3078),a=s(7710),d=s(3494),l=s(6287),n=s(400),o=s(8424),c=s(4353),p=s.n(c),m=s(8867),u=s.n(m),h=s(8906),f=s.n(h),x=s(6279),y=s.n(x),v=s(6540),j=s(3959),g=s(1568);s(6033);var w=s(8446);let{RangePicker:O}=d.A;p().extend(y()),p().extend(u()),p().extend(f()),p().locale("zh-cn");let T=e=>{if(e.startsWith("react-native-update-cli"))return(0,i.jsxs)("div",{children:["cli ",e.split("/")[1]]});let{browser:t,os:s}=(0,w.O)(e);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{children:[t.name," ",t.version]}),(0,i.jsxs)("div",{children:[s.name," ",s.version]})]})},{Text:S}=l.A,A={"POST /user/login":"登录","POST /user/register":"注册","POST /user/activate":"激活账户","POST /user/activate/sendmail":"发送激活邮件","POST /user/resetpwd/sendmail":"发送重置密码邮件","POST /user/resetpwd/reset":"重置密码","POST /app/create":"创建应用","PUT /app/{id}":"修改应用设置","DELETE /app/{id}":"删除应用","POST /orders":"创建订单","POST alipayCallback":"支付","POST /upload":"上传文件","POST /app/{id}/package/create":"创建原生包","PUT /app/{id}/package/{id}":"修改原生包设置","DELETE /app/{id}/package/{id}":"删除原生包","POST /app/{id}/version/create":"创建热更包","PUT /app/{id}/version/{id}":"修改热更包设置","DELETE /app/{id}/version/{id}":"删除热更包","POST /app/{id}/binding":"创建/更新绑定","DELETE /app/{id}/binding/{id}":"删除绑定","POST /api-token/create":"创建 API Key","DELETE /api-token/{id}":"删除 API Key"},P=(e,t)=>{let s=t.replace(/\/\d+/g,"/{id}").replace(/\/$/,"");return A[`${e.toUpperCase()} ${s}`]||`${e.toUpperCase()} ${t}`},k=[{title:"时间",dataIndex:"createdAt",width:180,sorter:(e,t)=>p()(e.createdAt).valueOf()-p()(t.createdAt).valueOf(),render:e=>{let t=p()(e);return(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{children:t.format("YYYY-MM-DD HH:mm:ss")}),(0,i.jsx)(S,{type:"secondary",className:"text-xs",children:t.fromNow()})]})}},{title:"操作",width:120,filters:Object.values(A).sort().map(e=>({text:e,value:e})),onFilter:(e,t)=>P(t.method,t.path)===e,render:(e,t)=>{let s=P(t.method,t.path),r="DELETE"===t.method.toUpperCase()?"#ff4d4f":void 0;return(0,i.jsx)("span",{style:r?{color:r}:void 0,children:s})}},{title:"状态码",dataIndex:"statusCode",width:100,render:e=>{let t=Number(e)>=500?"#ff4d4f":void 0;return(0,i.jsx)("span",{className:"font-medium",style:t?{color:t}:void 0,children:e})}},{title:"提交数据",width:300,ellipsis:{showTitle:!1},render:(e,t)=>{let{path:s,data:r}=t;if(s.startsWith("/upload"))if((null==r?void 0:r.ext)===".ppk")return(0,i.jsx)(S,{children:"热更包"});else return(0,i.jsx)(S,{children:"原生包"});return r?(delete r.deps,delete r.commit,(0,i.jsx)(S,{ellipsis:{tooltip:JSON.stringify(r,null,2)},children:JSON.stringify(r)})):(0,i.jsx)(S,{type:"secondary",children:"-"})}},{title:"设备信息",dataIndex:"userAgent",width:250,ellipsis:{showTitle:!1},render:(e,t)=>e||t.ip?(0,i.jsxs)("div",{title:e||t.ip,children:[e&&(0,i.jsx)("div",{children:T(e)}),t.ip&&(0,i.jsx)("div",{className:"mt-1",children:(0,i.jsxs)(S,{type:"secondary",className:"text-xs",children:["IP: ",t.ip]})})]}):(0,i.jsx)(S,{type:"secondary",children:"-"})},{title:"API Key",dataIndex:"apiTokens",width:150,render:e=>e?(0,i.jsxs)(S,{className:"font-mono text-xs",children:[e.name,"(",e.tokenSuffix,")"]}):(0,i.jsx)(S,{type:"secondary",children:"-"})}],E=()=>{let[e,t]=(0,v.useState)(0),[s,d]=(0,v.useState)(20),[l,c]=(0,v.useState)(null),{auditLogs:m,isLoading:u}=(0,g.UJ)({offset:0,limit:1e3}),h=(0,v.useMemo)(()=>{if(!l||!l[0]&&!l[1])return m;let[e,t]=l;return m.filter(s=>{let i=p()(s.createdAt);return e&&t?i.isSameOrAfter(e.startOf("day"))&&i.isSameOrBefore(t.endOf("day")):e?i.isSameOrAfter(e.startOf("day")):!t||i.isSameOrBefore(t.endOf("day"))})},[m,l]);return(0,i.jsxs)("div",{className:"page-section",children:[(0,i.jsx)("div",{className:"mb-4",children:(0,i.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("h2",{className:"text-lg md:text-xl font-semibold flex items-center gap-2",children:[(0,i.jsx)(r.A,{}),"操作日志"]}),(0,i.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:"日志功能从 2025 年 11 月 17 日开始测试，没有更早的数据。将仅保留 180 天内的数据。"})]}),(0,i.jsxs)("div",{className:"flex flex-col gap-2 md:flex-row md:items-center",children:[(0,i.jsx)(O,{className:"w-full md:w-auto",value:l,onChange:e=>{if((null==e?void 0:e[0])&&(null==e?void 0:e[1])){let t=e[0];if(e[1].diff(t,"day")>180){let e=t.add(180,"day");c([t,e])}else c(e)}else c(e);t(0)},format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],allowClear:!0,disabledDate:e=>{if(!e)return!1;let t=p()(),s=t.subtract(180,"day");if(e.isAfter(t,"day")||e.isBefore(s,"day"))return!0;if((null==l?void 0:l[0])&&!l[1]){let t=l[0],s=t.add(180,"day");return e.isBefore(t,"day")||e.isAfter(s,"day")}if(!(null==l?void 0:l[0])&&(null==l?void 0:l[1])){let t=l[1],s=t.subtract(180,"day");return e.isAfter(t,"day")||e.isBefore(s,"day")}return!1}}),(0,i.jsx)(n.Ay,{type:"primary",icon:(0,i.jsx)(a.A,{}),onClick:()=>{if(0===h.length)return;let e=h.map(e=>{let t=p()(e.createdAt),s=P(e.method,e.path),i="-",r="-";if(e.userAgent)if(e.userAgent.startsWith("react-native-update-cli")){let t=e.userAgent.split("/")[1]||"";i=`cli ${t}`.trim(),r="-"}else{let{browser:t,os:s}=(0,w.O)(e.userAgent);i=`${t.name||"-"} ${t.version||""}`.trim(),r=`${s.name||"-"} ${s.version||""}`.trim()}return{时间:t.format("YYYY-MM-DD HH:mm:ss"),操作:s,状态码:e.statusCode,提交数据:e.data?JSON.stringify(e.data):"-",浏览器:i,操作系统:r,IP地址:e.ip||"-","API Key":e.apiTokens?`${e.apiTokens.name}(${e.apiTokens.tokenSuffix})`:"-"}}),t=j.Wp.book_new(),s=j.Wp.json_to_sheet(e);s["!cols"]=[{wch:20},{wch:15},{wch:10},{wch:40},{wch:20},{wch:20},{wch:15},{wch:15}],j.Wp.book_append_sheet(t,s,"操作日志");let i=`操作日志_${p()().format("YYYY-MM-DD_HH-mm-ss")}.xlsx`;j._h(t,i)},disabled:0===h.length,className:"w-full md:w-auto",children:"导出 Excel"})]})]})}),(0,i.jsx)(o.A,{rowKey:"id",columns:k,dataSource:h,loading:u,pagination:{showSizeChanger:!0,showQuickJumper:!0,total:h.length,current:e/s+1,pageSize:s,showTotal:e=>`共 ${e} 条记录`,onChange(e,s){s&&(t((e-1)*s),d(s))}},scroll:{x:1200}})]})},N=E}}]);