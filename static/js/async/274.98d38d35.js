"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["274"],{6113(e,t,s){s.r(t),s.d(t,{Component:()=>I});var i=s(4848),r=s(6385),n=s(4811),a=s(7665),l=s(2454),u=s(5419),o=s(6287),c=s(6380),d=s(1215),m=s(400),h=s(4840),p=s(8361),y=s(8032),x=s(6992),A=s(2387),f=s(3133),v=s(8448),b=s(4559),g=s(4353),j=s.n(g),S=s(6540),w=s(271),C=s(7762);let{Title:O}=o.A,E=e=>{let{value:t,onChange:s}=e,r=(0,S.useRef)(null),n=(0,S.useRef)(null);return(0,S.useEffect)(()=>(r.current&&!n.current&&(n.current=new w.uL({target:r.current,props:{content:{text:t},onChange:(e,t,i)=>{let{contentErrors:r}=i;!r&&("json"in e&&void 0!==e.json?s(JSON.stringify(e.json,null,2)):"text"in e&&s(e.text))},mode:"text"}})),()=>{n.current&&(n.current.destroy(),n.current=null)}),[]),(0,S.useEffect)(()=>{n.current&&n.current.update({text:t})},[t]),(0,i.jsx)("div",{ref:r,style:{height:200}})},I=()=>{let e=(0,a.jE)(),[t,s]=(0,S.useState)(""),[o,g]=(0,S.useState)(""),[w,I]=(0,S.useState)(!1),[N,M]=(0,S.useState)(null),[k]=c.A.useForm(),[R,U]=(0,S.useState)("");(0,S.useEffect)(()=>{let e=setTimeout(()=>g(t),300);return()=>clearTimeout(e)},[t]);let{data:q,isLoading:K}=(0,l.I)({queryKey:["adminUsers",o],queryFn:()=>C.i.searchUsers(o||void 0)}),$=(0,u.n)({mutationFn:e=>{let{id:t,data:s}=e;return C.i.updateUser(t,s)},onSuccess:()=>{d.Ay.success("用户信息已更新"),I(!1),e.invalidateQueries({queryKey:["adminUsers"]})},onError:e=>{d.Ay.error(e.message)}}),P=async()=>{try{let e=await k.validateFields();if(!N)return;let t={name:e.name,email:e.email,tier:e.tier,status:e.status,tierExpiresAt:e.tierExpiresAt?e.tierExpiresAt.toISOString():null};if(R.trim())try{t.quota=JSON.parse(R)}catch{d.Ay.error("Quota 格式无效，请输入有效的 JSON");return}else t.quota=null;$.mutate({id:N.id,data:t})}catch(e){d.Ay.error(e.message)}},F=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"邮箱",dataIndex:"email",key:"email"},{title:"用户名",dataIndex:"name",key:"name"},{title:"状态",dataIndex:"status",key:"status",width:100,render:e=>(0,i.jsx)("span",{className:"normal"===e?"text-green-600":"text-orange-500",children:"normal"===e?"正常":"未验证"})},{title:"套餐",dataIndex:"tier",key:"tier",width:100},{title:"套餐过期时间",dataIndex:"tierExpiresAt",key:"tierExpiresAt",width:180,render:e=>e?j()(e).format("YYYY-MM-DD HH:mm"):"-"},{title:"自定义配额",dataIndex:"quota",key:"quota",width:100,render:e=>e?"有":"-"},{title:"操作",key:"action",width:80,render:(e,t)=>(0,i.jsx)(m.Ay,{type:"link",icon:(0,i.jsx)(r.A,{}),onClick:()=>{M(t),k.setFieldsValue({name:t.name,email:t.email,tier:t.tier,status:t.status,tierExpiresAt:t.tierExpiresAt?j()(t.tierExpiresAt):null}),U(t.quota?JSON.stringify(t.quota,null,2):""),I(!0)},children:"编辑"})}];return(0,i.jsxs)("div",{className:"page-section",children:[(0,i.jsxs)(h.A,{children:[(0,i.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4",children:[(0,i.jsx)(O,{level:4,className:"m-0!",children:"用户管理"}),(0,i.jsx)(p.A,{placeholder:"搜索用户名或邮箱",prefix:(0,i.jsx)(n.A,{}),value:t,onChange:e=>s(e.target.value),allowClear:!0,className:"w-full md:w-72"})]}),(0,i.jsx)(y.A,{spinning:K,children:(0,i.jsx)(x.A,{dataSource:(null==q?void 0:q.data)||[],columns:F,rowKey:"id",pagination:{pageSize:20},scroll:{x:900}})})]}),(0,i.jsx)(A.A,{title:`编辑用户: ${null==N?void 0:N.email}`,open:w,onCancel:()=>I(!1),footer:[(0,i.jsx)(m.Ay,{onClick:()=>I(!1),children:"取消"},"cancel"),(0,i.jsx)(m.Ay,{type:"primary",loading:$.isPending,onClick:P,children:"保存"},"save")],width:600,children:(0,i.jsx)(c.A,{form:k,layout:"vertical",className:"mt-4",children:(0,i.jsxs)(f.A,{className:"w-full",direction:"vertical",size:"middle",children:[(0,i.jsx)(c.A.Item,{name:"name",label:"用户名",className:"mb-0!",children:(0,i.jsx)(p.A,{})}),(0,i.jsx)(c.A.Item,{name:"email",label:"邮箱",className:"mb-0!",children:(0,i.jsx)(p.A,{})}),(0,i.jsx)(c.A.Item,{name:"tier",label:"套餐",className:"mb-0!",children:(0,i.jsx)(v.A,{options:[{value:"free",label:"免费版"},{value:"standard",label:"标准版"},{value:"premium",label:"高级版"},{value:"pro",label:"专业版"},{value:"custom",label:"定制版"}]})}),(0,i.jsx)(c.A.Item,{name:"status",label:"状态",className:"mb-0!",children:(0,i.jsx)(v.A,{options:[{value:"normal",label:"正常"},{value:"unverified",label:"未验证"}]})}),(0,i.jsx)(c.A.Item,{name:"tierExpiresAt",label:"套餐过期时间",className:"mb-0!",children:(0,i.jsx)(b.A,{showTime:!0,className:"w-full"})}),(0,i.jsx)(c.A.Item,{label:"自定义配额 (JSON，留空则使用默认配额)",className:"mb-0!",children:(0,i.jsx)(E,{value:R,onChange:U})})]})})})]})}},7762(e,t,s){s.d(t,{i:()=>r});var i=s(6126);let r={getConfig:()=>(0,i.Ay)("get","/admin/config"),setConfig:(e,t)=>(0,i.Ay)("post","/admin/config",{key:e,value:t}),deleteConfig:e=>(0,i.Ay)("delete",`/admin/config/${e}`),searchUsers:e=>(0,i.Ay)("get",e?`/admin/users?search=${encodeURIComponent(e)}`:"/admin/users"),updateUser:(e,t)=>(0,i.Ay)("put",`/admin/users/${e}`,t),searchApps:e=>(0,i.Ay)("get",e?`/admin/apps?search=${encodeURIComponent(e)}`:"/admin/apps"),searchVersions:e=>{let t=new URLSearchParams;(null==e?void 0:e.search)&&t.set("search",e.search),(null==e?void 0:e.appId)&&t.set("appId",String(e.appId));let s=t.toString();return(0,i.Ay)("get",s?`/admin/versions?${s}`:"/admin/versions")},updateVersion:(e,t)=>(0,i.Ay)("put",`/admin/versions/${e}`,t),updateApp:(e,t)=>(0,i.Ay)("put",`/admin/apps/${e}`,t)}},5419(e,t,s){s.d(t,{n:()=>c});var i=s(6540),r=s(6158),n=s(6261),a=s(6500),l=s(4880),u=class extends a.Q{#e;#t=void 0;#s;#i;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#r()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,l.f8)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#s,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,l.EN)(t.mutationKey)!==(0,l.EN)(this.options.mutationKey)?this.reset():this.#s?.state.status==="pending"&&this.#s.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#s?.removeObserver(this)}onMutationUpdate(e){this.#r(),this.#n(e)}getCurrentResult(){return this.#t}reset(){this.#s?.removeObserver(this),this.#s=void 0,this.#r(),this.#n()}mutate(e,t){return this.#i=t,this.#s?.removeObserver(this),this.#s=this.#e.getMutationCache().build(this.#e,this.options),this.#s.addObserver(this),this.#s.execute(e)}#r(){let e=this.#s?.state??(0,r.$)();this.#t={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#n(e){n.jG.batch(()=>{if(this.#i&&this.hasListeners()){let t=this.#t.variables,s=this.#t.context,i={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};if(e?.type==="success"){try{this.#i.onSuccess?.(e.data,t,s,i)}catch(e){Promise.reject(e)}try{this.#i.onSettled?.(e.data,null,t,s,i)}catch(e){Promise.reject(e)}}else if(e?.type==="error"){try{this.#i.onError?.(e.error,t,s,i)}catch(e){Promise.reject(e)}try{this.#i.onSettled?.(void 0,e.error,t,s,i)}catch(e){Promise.reject(e)}}}this.listeners.forEach(e=>{e(this.#t)})})}},o=s(7665);function c(e,t){let s=(0,o.jE)(t),[r]=i.useState(()=>new u(s,e));i.useEffect(()=>{r.setOptions(e)},[r,e]);let a=i.useSyncExternalStore(i.useCallback(e=>r.subscribe(n.jG.batchCalls(e)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),c=i.useCallback((e,t)=>{r.mutate(e,t).catch(l.lQ)},[r]);if(a.error&&(0,l.GU)(r.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}}}]);