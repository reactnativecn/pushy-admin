"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["41"],{6304:function(e,t,s){s.r(t),s.d(t,{AuditLogs:()=>Y,Component:()=>k,getUA:()=>S});var i=s(4848),r=s(3078),d=s(7710),a=s(8738),n=s(4042),l=s(1876),o=s(697),c=s(2894),p=s(4353),u=s.n(p),h=s(8867),f=s.n(h),m=s(8906),x=s.n(m),v=s(6279),y=s.n(v),j=s(6540),g=s(3959),w=s(1568);s(6033);var O=s(8446);let{RangePicker:A}=a.A;u().extend(y()),u().extend(f()),u().extend(x()),u().locale("zh-cn");let S=e=>{if(e.startsWith("react-native-update-cli"))return(0,i.jsxs)("div",{children:["cli ",e.split("/")[1]]});let{browser:t,os:s}=(0,O.O)(e);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{children:[t.name," ",t.version]}),(0,i.jsxs)("div",{children:[s.name," ",s.version]})]})},{Text:T}=n.A,P={"POST /user/login":"登录","POST /user/register":"注册","POST /user/activate":"激活账户","POST /user/activate/sendmail":"发送激活邮件","POST /user/resetpwd/sendmail":"发送重置密码邮件","POST /user/resetpwd/reset":"重置密码","POST /app/create":"创建应用","PUT /app/{id}":"更新应用","DELETE /app/{id}":"删除应用","POST /orders":"创建订单","POST /upload":"上传文件","PUT /app/{id}/package/{id}":"修改原生包设置","DELETE /app/{id}/package/{id}":"删除原生包","POST /app/{id}/version/{id}":"创建热更包","PUT /app/{id}/version/{id}":"修改热更包设置","DELETE /app/{id}/version/{id}":"删除热更包","POST /app/{id}/binding/":"创建/更新绑定","DELETE /app/{id}/binding/{id}":"删除绑定"},b=(e,t)=>{let s=t.replace(/\/\d+/g,"/{id}");return P[`${e.toUpperCase()} ${s}`]||`${e.toUpperCase()} ${t}`},E=[{title:"时间",dataIndex:"createdAt",width:180,sorter:(e,t)=>u()(e.createdAt).valueOf()-u()(t.createdAt).valueOf(),render:e=>{let t=u()(e);return(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{children:t.format("YYYY-MM-DD HH:mm:ss")}),(0,i.jsx)(T,{type:"secondary",className:"text-xs",children:t.fromNow()})]})}},{title:"操作",width:120,filters:Object.values(P).sort().map(e=>({text:e,value:e})),onFilter:(e,t)=>b(t.method,t.path)===e,render:(e,t)=>{let s=b(t.method,t.path),r="DELETE"===t.method.toUpperCase()?"#ff4d4f":void 0;return(0,i.jsx)("span",{style:r?{color:r}:void 0,children:s})}},{title:"状态码",dataIndex:"statusCode",width:100,render:e=>{let t=Number(e)>=500?"#ff4d4f":void 0;return(0,i.jsx)("span",{className:"font-medium",style:t?{color:t}:void 0,children:e})}},{title:"提交数据",width:300,ellipsis:{showTitle:!1},render:(e,t)=>{let{path:s,data:r}=t;if(s.startsWith("/upload"))if((null==r?void 0:r.ext)===".ppk")return(0,i.jsx)(T,{children:"热更包"});else return(0,i.jsx)(T,{children:"原生包"});return r?(0,i.jsx)(T,{ellipsis:{tooltip:JSON.stringify(r,null,2)},children:JSON.stringify(r)}):(0,i.jsx)(T,{type:"secondary",children:"-"})}},{title:"设备信息",dataIndex:"userAgent",width:250,ellipsis:{showTitle:!1},render:(e,t)=>e||t.ip?(0,i.jsxs)("div",{title:e||t.ip,children:[e&&(0,i.jsx)("div",{children:S(e)}),t.ip&&(0,i.jsx)("div",{className:"mt-1",children:(0,i.jsxs)(T,{type:"secondary",className:"text-xs",children:["IP: ",t.ip]})})]}):(0,i.jsx)(T,{type:"secondary",children:"-"})},{title:"API Key",dataIndex:["apiTokens","tokenSuffix"],width:120,render:e=>e?(0,i.jsxs)(T,{className:"font-mono text-xs",children:["****",e]}):(0,i.jsx)(T,{type:"secondary",children:"-"})}],Y=()=>{let[e,t]=(0,j.useState)(0),[s,a]=(0,j.useState)(20),[n,p]=(0,j.useState)(null),{auditLogs:h,isLoading:f}=(0,w.UJ)({offset:0,limit:1e3}),m=(0,j.useMemo)(()=>{if(!n||!n[0]&&!n[1])return h;let[e,t]=n;return h.filter(s=>{let i=u()(s.createdAt);return e&&t?i.isSameOrAfter(e.startOf("day"))&&i.isSameOrBefore(t.endOf("day")):e?i.isSameOrAfter(e.startOf("day")):!t||i.isSameOrBefore(t.endOf("day"))})},[h,n]);return(0,i.jsxs)("div",{className:"p-6",children:[(0,i.jsx)("div",{className:"mb-4",children:(0,i.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[(0,i.jsx)(r.A,{}),"操作日志"]}),(0,i.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:"日志功能从 2025 年 11 月 17 日开始测试，没有更早的数据。将仅保留 180 天内的数据。"})]}),(0,i.jsxs)(l.A,{children:[(0,i.jsx)(A,{value:n,onChange:e=>{if((null==e?void 0:e[0])&&(null==e?void 0:e[1])){let t=e[0];if(e[1].diff(t,"day")>180){let e=t.add(180,"day");p([t,e])}else p(e)}else p(e);t(0)},format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],allowClear:!0,disabledDate:e=>{if(!e)return!1;let t=u()(),s=t.subtract(180,"day");if(e.isAfter(t,"day")||e.isBefore(s,"day"))return!0;if((null==n?void 0:n[0])&&!n[1]){let t=n[0],s=t.add(180,"day");return e.isBefore(t,"day")||e.isAfter(s,"day")}if(!(null==n?void 0:n[0])&&(null==n?void 0:n[1])){let t=n[1],s=t.subtract(180,"day");return e.isAfter(t,"day")||e.isBefore(s,"day")}return!1}}),(0,i.jsx)(o.Ay,{type:"primary",icon:(0,i.jsx)(d.A,{}),onClick:()=>{if(0===m.length)return;let e=m.map(e=>{var t;let s=u()(e.createdAt),i=b(e.method,e.path),r="-",d="-";if(e.userAgent)if(e.userAgent.startsWith("react-native-update-cli")){let t=e.userAgent.split("/")[1]||"";r=`cli ${t}`.trim(),d="-"}else{let{browser:t,os:s}=(0,O.O)(e.userAgent);r=`${t.name||"-"} ${t.version||""}`.trim(),d=`${s.name||"-"} ${s.version||""}`.trim()}return{时间:s.format("YYYY-MM-DD HH:mm:ss"),操作:i,状态码:e.statusCode,提交数据:e.data?JSON.stringify(e.data):"-",浏览器:r,操作系统:d,IP地址:e.ip||"-","API Key":`****${(null==(t=e.apiTokens)?void 0:t.tokenSuffix)||"-"}`}}),t=g.Wp.book_new(),s=g.Wp.json_to_sheet(e);s["!cols"]=[{wch:20},{wch:15},{wch:10},{wch:40},{wch:20},{wch:20},{wch:15},{wch:15}],g.Wp.book_append_sheet(t,s,"操作日志");let i=`操作日志_${u()().format("YYYY-MM-DD_HH-mm-ss")}.xlsx`;g._h(t,i)},disabled:0===m.length,children:"导出 Excel"})]})]})}),(0,i.jsx)(c.A,{rowKey:"id",columns:E,dataSource:m,loading:f,pagination:{showSizeChanger:!0,showQuickJumper:!0,total:m.length,current:e/s+1,pageSize:s,showTotal:e=>`共 ${e} 条记录`,onChange(e,s){s&&(t((e-1)*s),a(s))}},scroll:{x:1200}})]})},k=Y}}]);