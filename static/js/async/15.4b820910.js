"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["15"],{1586(e,t,l){l.r(t),l.d(t,{Component:()=>j});var r=l(4848),a=l(7833),n=l(2454),s=l(6287),o=l(8150),i=l(4840),u=l(3133),c=l(2685),d=l(8448),h=l(8032),m=l(4353),g=l.n(m),v=l(6540),f=l(391);let{Title:p}=s.A,{RangePicker:x}=o.A,y="total",b=[{label:"rn",value:"rn"},{label:"os",value:"os"},{label:"rnu",value:"rnu"}],j=()=>{let[e,t]=(0,v.useState)([g()().subtract(24,"hour"),g()()]),[l,s]=(0,v.useState)("pv"),[o,m]=(0,v.useState)("rn"),j=(0,v.useRef)([]),M=(0,v.useRef)(""),{data:A,isLoading:S}=(0,n.I)({queryKey:["globalMetrics",e[0].toISOString(),e[1].toISOString(),l],queryFn:()=>f.F.getGlobalMetrics({start:e[0].toISOString(),end:e[1].toISOString(),mode:l}),enabled:!!e[0]&&!!e[1]}),w=(0,v.useMemo)(()=>{if(!(null==A?void 0:A.data)||!(null==A?void 0:A.dict))return[];let e=[];for(let t of A.data)for(let[l,r]of t.data){let a=A.dict[l]||"";if("_total"===a)continue;let n=a.replace("\x1f",": ");a.endsWith("\x1f")&&(n=a.replace("\x1f",": unknown")),e.push({time:t.time,value:r,category:n})}return e},[A]),F=(0,v.useMemo)(()=>w.length?w.filter(e=>{var t;let l;return(-1===(l=(t=e.category).indexOf(":"))?t.trim():t.slice(0,l).trim())===o}):[],[w,o]),N=(0,v.useMemo)(()=>{let e=new Map;for(let t of F)e.set(t.category,(e.get(t.category)||0)+t.value);return e},[F]),C=(0,v.useMemo)(()=>Array.from(N.entries()).sort((e,t)=>t[1]-e[1]).map(e=>{let[t]=e;return t}),[N]),O=(0,v.useMemo)(()=>{if(!F.length)return[];let e=new Map;for(let t of F)e.set(t.time,(e.get(t.time)||0)+t.value);return Array.from(e.entries()).map(e=>{let[t,l]=e;return{time:t,value:l,category:y}}).sort((e,t)=>g()(e.time).valueOf()-g()(t.time).valueOf())},[F]),k=(0,v.useMemo)(()=>{let e=C.slice(0,10);return 0===O.length?e:[y,...e]},[C,O]),I=(0,v.useMemo)(()=>0===C.length?[]:0===O.length?C:[y,...C],[C,O]),R=(0,v.useMemo)(()=>F.length||O.length?[...F,...O]:[],[F,O]);j.current=k;let B=(0,v.useMemo)(()=>{if(!F.length)return{total:0,categories:new Map};let e=0,t=new Map;for(let l of F){e+=l.value;let r=t.get(l.category)||0;t.set(l.category,r+l.value)}return{total:e,categories:t}},[F]),D=(0,v.useMemo)(()=>Array.from(B.categories.entries()).sort((e,t)=>t[1]-e[1]).slice(0,10),[B.categories]),V={interaction:{legendFilter:!0,tooltip:{shared:!0}},data:R,xField:e=>new Date(e.time),yField:"value",colorField:"category",shapeField:"smooth",axis:{x:{title:"时间",labelAutoRotate:!0,labelFormatter:e=>{let t=g()(e);return t.isValid()?t.format("MM/DD HH:mm"):e}},y:{title:l.toUpperCase()}},tooltip:{channel:"y"},legend:{position:"top"},scale:I.length?{color:{domain:I}}:void 0,onReady:e=>{let{chart:t}=e;try{t.on("afterrender",()=>{let e=j.current;if(!e.length)return;let l=e.join("|");l!==M.current&&(t.emit("legend:filter",{data:{channel:"color",values:e}}),M.current=l)})}catch(e){console.error(e)}},height:480};return(0,r.jsx)("div",{className:"p-6",children:(0,r.jsxs)(i.A,{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)(p,{level:4,className:"m-0!",children:"全局数据统计"}),(0,r.jsxs)(u.A,{children:[(0,r.jsxs)(c.A.Group,{value:l,onChange:e=>s(e.target.value),children:[(0,r.jsx)(c.A.Button,{value:"pv",children:"PV"}),(0,r.jsx)(c.A.Button,{value:"uv",children:"UV"})]}),(0,r.jsx)(d.A,{placeholder:"筛选 Key",showSearch:{optionFilterProp:"label"},value:o,options:b,onChange:e=>m(e),className:"w-40"}),(0,r.jsx)(x,{showTime:!0,value:e,onChange:e=>{(null==e?void 0:e[0])&&e[1]&&t([e[0],e[1]])},presets:[{label:"过去1小时",value:[g()().subtract(1,"hour"),g()()]},{label:"过去6小时",value:[g()().subtract(6,"hour"),g()()]},{label:"过去24小时",value:[g()().subtract(24,"hour"),g()()]},{label:"过去7天",value:[g()().subtract(7,"day"),g()()]},{label:"过去30天",value:[g()().subtract(30,"day"),g()()]}]})]})]}),(0,r.jsxs)(h.A,{spinning:S,children:[(0,r.jsx)(i.A,{size:"small",style:{marginBottom:20},children:R.length>0?(0,r.jsx)(a.A,{...V}):(0,r.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"暂无数据"})}),D.length>0&&(0,r.jsx)(i.A,{title:"分类统计 (Top 10)",size:"small",children:(0,r.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:D.map(e=>{let[t,l]=e;return(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded",children:[(0,r.jsx)("div",{className:"text-xs text-gray-500 truncate",title:t,children:t}),(0,r.jsx)("div",{className:"text-lg font-semibold",children:l.toLocaleString()})]},t)})})})]})]})})}}}]);