"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["89"],{2584:function(e,a,l){l.r(a),l.d(a,{Manage:()=>ep,Component:()=>ej});var s=l(4848),n=l(2700),t=l(339),i=l(6929),r=l(6115),d=l(8657),c=l(7152),o=l(6370),m=l(4914),x=l(6248),u=l(8284),h=l(6677),p=l(9312),j=l(8243),y=l(8388),g=l(5625),A=l(6540),v=l(4824),f=l(9499),k=l(584),b=l(8129),N=l(5382),C=l(192);let I=(0,A.createContext)({appId:0,deepLink:"",setDeepLink:()=>{},packages:[],unusedPackages:[]}),w=()=>(0,A.useContext)(I),$=e=>{let{children:a,appId:l}=e,[n,t]=(0,A.useState)(window.localStorage.getItem(`${l}_deeplink`)??""),{packages:i=[],unusedPackages:r=[],isLoading:d}=(0,g.xi)(l),c=(0,A.useMemo)(()=>({appId:l,deepLink:n,setDeepLink:t,packages:i,unusedPackages:r,packagesLoading:d}),[l,n,i,r,d]);return(0,s.jsx)(I.Provider,{value:c,children:a})};var F=l(9951),S=l(4353),P=l.n(S),D=l(3605),V=l.n(D),O=l(4942);let _=e=>{let{commit:a}=e;if(!a)return(0,s.jsx)(F.A,{className:"ant-typography-edit",content:(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"text-center my-1 mx-auto",children:[(0,s.jsx)("div",{className:"font-bold",children:"最近的提交："}),(0,s.jsx)("div",{className:"text-gray-500",children:"需要使用 cli v1.42.0+ 版本上传，且使用 git 管理代码才能查看提交记录"})]})}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(O.A,{}),onClick:()=>{}})});let{origin:l,hash:n,message:t,author:i}=a,r="";if(l)try{let{owner:e,name:a,source:s}=V()(l);r=`https://${s}/${e}/${a}/commit/${n}`}catch(e){console.error(e)}let d=P()(1e3*a.timestamp);return(0,s.jsx)(F.A,{className:"ant-typography-edit",content:(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"my-1 mx-auto",children:[(0,s.jsx)("div",{className:"font-bold",children:"最近的提交："}),(0,s.jsxs)("div",{children:["作者：",i]}),(0,s.jsxs)("div",{children:["时间：",d.fromNow(),"（",d.format("YYYY-MM-DD HH:mm:ss"),"）"]}),(0,s.jsxs)("div",{children:["摘要：",t]}),(0,s.jsx)("hr",{}),r?(0,s.jsx)("a",{className:"text-xs",href:r,target:"_blank",rel:"noreferrer",children:n}):(0,s.jsx)("span",{className:"text-xs",children:n})]})}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(O.A,{}),onClick:()=>{}})})};var T=l(5307),E=l(8389),M=l(6777);function B(e){let{className:a,...l}=e,n=(0,A.useRef)(null),t=(0,A.useRef)(null);return(0,A.useEffect)(()=>(t.current=(0,M._j)({target:n.current,props:{mode:M.Kt.text,...l}}),()=>{t.current&&t.current.destroy()}),[]),(0,A.useEffect)(()=>{var e;null==(e=t.current)||e.updateProps(l)},[l]),(0,s.jsx)("div",{className:a,ref:n})}var K=l(4565),L=l(8231);l(3115);let z=new K.A({detectCircular:!0,maxDepth:1/0,showModifications:!0,arrayDiffMethod:"lcs"}),H=e=>{let{oldDeps:a,newDeps:l}=e;if(!a||!l)return null;let n=z.diff(a,l);return(0,s.jsx)(L.A,{diff:n,highlightInlineDiff:!0})},Y=e=>{let{deps:a,name:l}=e,{packages:n,appId:t}=w(),{versions:i}=(0,g.jh)({appId:t,limit:1e3}),[r,d]=(0,A.useState)(null);return(0,s.jsx)(F.A,{className:"ant-typography-edit",afterOpenChange:e=>{e||d(null)},content:(0,s.jsx)("div",{children:(0,s.jsx)("div",{className:"text-center my-1 mx-auto",children:a?(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,s.jsxs)("h4",{children:["JavaScript 依赖列表",!r&&`(${l})`,(0,s.jsx)("div",{children:r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:"font-normal",children:r.newName}),` <-> ${l}`]})}),(0,s.jsx)("div",{className:"absolute right-8 top-7",children:r?(0,s.jsx)(h.Ay,{className:"content-end",onClick:()=>{d(null)},children:"返回"}):(0,s.jsx)(E.A.Button,{className:"",menu:{items:[{key:"package",type:"group",label:"原生包",children:n.filter(e=>!!e.deps).map(e=>({key:`p_${e.id}`,label:e.name}))},{key:"version",type:"group",label:"热更包",children:i.filter(e=>!!e.deps).map(e=>({key:`v_${e.id}`,label:e.name}))}],onClick:e=>{let{key:l}=e,[s,t]=l.split("_");if("p"===s){let e=n.find(e=>e.id===+t);d({oldDeps:null==e?void 0:e.deps,newDeps:a,newName:"原生包 "+(null==e?void 0:e.name)})}else{let e=i.find(e=>e.id===+t);d({oldDeps:null==e?void 0:e.deps,newDeps:a,newName:"热更包 "+(null==e?void 0:e.name)})}}},children:"对比变更"})})]}),(0,s.jsx)("div",{className:"max-h-[50vh] overflow-y-auto",children:r?(0,s.jsx)(H,{oldDeps:r.oldDeps,newDeps:r.newDeps}):(0,s.jsx)(B,{content:{json:Object.keys(a).sort().reduce((e,l)=>(e[l]=a[l],e),{})},mode:M.Kt.tree,mainMenuBar:!1,statusBar:!1,readOnly:!0})}),(0,s.jsxs)("div",{className:"text-gray-500 my-4",children:["仅在",(0,s.jsx)("span",{className:"font-bold underline",children:"上传"}),"时抓取package.json的直接依赖， 不保证严格匹配包内容，仅供参考。"]})]})}):(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"JavaScript 依赖列表"}),(0,s.jsx)("div",{className:"text-gray-500",children:"需要使用 cli v1.42.0+ 版本上传才能查看依赖列表"})]})})}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(T.A,{}),onClick:()=>{}})})},R=e=>{let{dataSource:a,loading:l}=e;return(0,s.jsx)(k.A,{loading:l,className:"packages",size:"small",dataSource:a,renderItem:e=>(0,s.jsx)(U,{item:e})})},U=e=>{let{item:a}=e,{appId:l}=w();return(0,s.jsx)("div",{className:"bg-white my-0 [&_li]:!px-0",children:(0,s.jsx)(k.A.Item,{className:"p-2",children:(0,s.jsx)(k.A.Item.Meta,{title:(0,s.jsxs)(c.A,{align:"middle",children:[(0,s.jsxs)(o.A,{flex:1,children:[a.name,a.status&&"normal"!==a.status&&(0,s.jsx)(x.A,{className:"ml-2",children:J[a.status]})]}),(0,s.jsx)(Y,{deps:a.deps,name:"原生包 "+a.name}),(0,s.jsx)(_,{commit:a.commit}),(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(v.A,{}),onClick:()=>(function(e,a){let{note:l,status:n}=e;r.A.confirm({icon:null,closable:!0,maskClosable:!0,content:(0,s.jsxs)(d.A,{layout:"vertical",initialValues:e,children:[(0,s.jsx)(d.A.Item,{name:"note",label:"备注",children:(0,s.jsx)(b.A,{placeholder:"添加原生包备注",onChange:e=>{let{target:a}=e;return l=a.value}})}),(0,s.jsx)(d.A.Item,{name:"status",label:"状态",children:(0,s.jsxs)(N.A,{onSelect:e=>{n=e},children:[(0,s.jsx)(N.A.Option,{value:"normal",children:"正常"}),(0,s.jsx)(N.A.Option,{value:"paused",children:"暂停"}),(0,s.jsx)(N.A.Option,{value:"expired",children:"过期"})]})})]}),async onOk(){await y.F.updatePackage({appId:a,packageId:e.id,params:{note:l,status:n}})}})})(a,l)}),(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(f.A,{}),onClick:()=>{r.A.confirm({title:`删除后无法恢复，确定删除原生包“${a.name}”？`,maskClosable:!0,okButtonProps:{danger:!0},async onOk(){await y.F.deletePackage({appId:l,packageId:a.id})}})},danger:!0})]}),description:(0,s.jsxs)("div",{children:[a.note&&(0,s.jsxs)(C.A.Paragraph,{className:"mb-0",type:"secondary",ellipsis:{tooltip:a.note},children:["备注：",a.note]}),(0,s.jsx)("div",{className:"text-xs flex flex-col gap-1",children:(0,s.jsxs)("div",{children:["编译时间：",a.buildTime]})})]})})})})},J={paused:"暂停",expired:"过期"};var W=l(3909),Q=l(9405),q=l(1671);let G=()=>{let{user:e}=(0,g.Py)(),{appId:a}=w(),l=d.A.useWatch("appKey"),n=d.A.useWatch("ignoreBuildTime");return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(d.A.Item,{label:"AppId",layout:"vertical",children:(0,s.jsx)(C.A.Paragraph,{className:"!mb-0",type:"secondary",copyable:!0,children:a})}),(0,s.jsx)(d.A.Item,{label:"AppKey",name:"appKey",layout:"vertical",children:(0,s.jsx)(C.A.Paragraph,{className:"!mb-0",type:"secondary",copyable:!0,children:l})}),(0,s.jsx)(d.A.Item,{label:"应用名",name:"name",layout:"vertical",children:(0,s.jsx)(b.A,{})}),(0,s.jsx)(d.A.Item,{label:"原生包下载地址（当用户端的原生版本过期时，会使用此地址下载）",name:"downloadUrl",layout:"vertical",children:(0,s.jsx)(b.A,{})}),(0,s.jsx)(d.A.Item,{layout:"vertical",label:"启用热更新",name:"status",normalize:e=>e?"normal":"paused",getValueProps:e=>({value:"normal"===e||null==e}),children:(0,s.jsx)(q.A,{checkedChildren:"已启用",unCheckedChildren:"已暂停"})}),(0,s.jsx)(d.A.Item,{layout:"vertical",label:"忽略编译时间戳（高级版以上可启用）",name:"ignoreBuildTime",normalize:e=>e?"enabled":"disabled",getValueProps:e=>({value:"enabled"===e}),children:(0,s.jsx)(q.A,{disabled:((null==e?void 0:e.tier)==="free"||(null==e?void 0:e.tier)==="standard")&&"enabled"!==n,checkedChildren:"已启用",unCheckedChildren:"已禁用"})}),(0,s.jsx)(d.A.Item,{label:"删除应用",layout:"vertical",children:(0,s.jsx)(h.Ay,{type:"primary",icon:(0,s.jsx)(Q.A,{}),onClick:()=>{r.A.confirm({title:"应用删除后无法恢复",okText:"确认删除",okButtonProps:{danger:!0},async onOk(){await y.F.deleteApp(a),r.A.destroyAll(),W.QB.navigate(W.DQ.apps)}})},danger:!0,children:"删除"})})]})};var X=l(7280),Z=l(8274),ee=l(464),ea=l(3577),el=l(1476),es=l(8108),en=l(519),et=l(2675),ei=l(2258),er=l(2816);let ed=e=>{let{packages:a,versionId:l,config:n}=e,{packages:t,appId:i}=w(),r=t.filter(e=>!a.some(a=>e.id===a.id)),d=a.map(e=>{var a;let t=null==n||null==(a=n.rollout)?void 0:a[e.name],r=100===t||null==t,d=Number(t),c={items:r?[]:[{key:"full",label:"全量",icon:(0,s.jsx)(en.A,{}),onClick:()=>{y.F.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:null}}}}),y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:l}})}}]};d<50&&!r&&c.items.push({key:"gray",label:"灰度",icon:(0,s.jsx)(et.A,{}),onClick:()=>y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:l}}),children:[1,2,5,10,20,50].filter(e=>e>d).map(a=>({key:`${a}`,label:`${a}%`,onClick:()=>y.F.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:a}}}})}))}),c.items.length>0&&c.items.push({type:"divider"}),c.items.push({key:"unpublish",label:"取消绑定",icon:(0,s.jsx)(ei.A,{}),onClick:()=>{y.F.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:null}}}}),y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:null}})}});let o=(0,s.jsxs)(h.Ay,{size:"small",color:"primary",variant:r?"filled":"dashed",children:[(0,s.jsx)("span",{className:"font-bold",children:e.name}),(0,s.jsx)("span",{className:"text-xs",children:r?"":`(${t}%)`})]});return(0,s.jsx)(E.A,{menu:c,children:o},e.id)});return(0,s.jsxs)("div",{className:"flex flex-wrap gap-1",children:[d,0!==r.length&&(0,s.jsx)(E.A,{menu:{items:r.map(e=>({key:e.id,label:e.name,onClick:()=>y.F.updatePackage({appId:i,packageId:e.id,params:{versionId:l}}),children:[{key:"full",label:"全量",icon:(0,s.jsx)(en.A,{}),onClick:()=>y.F.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:null}}}})},{key:"gray",label:"灰度",icon:(0,s.jsx)(et.A,{}),children:[1,2,5,10,20,50].map(a=>({key:`${a}`,label:`${a}%`,onClick:()=>y.F.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:a}}}})}))}]}))},className:"ant-typography-edit",children:(0,s.jsx)(h.Ay,{type:"link",size:"small",icon:(0,s.jsx)(er.A,{}),children:"绑定"})})]})},ec=e=>{let{name:a,hash:l}=e,{appId:n,deepLink:t,setDeepLink:i}=w(),[r,d]=(0,A.useState)(!!t),c=r&&t.endsWith("://");(0,A.useEffect)(()=>{c&&window.localStorage.setItem(`${n}_deeplink`,t)},[n,t,c]);let o={type:"__rnPushyVersionHash",data:l},m=c?`${t}?${new URLSearchParams(o).toString()}`:JSON.stringify(o);return(0,s.jsx)(F.A,{className:"ant-typography-edit",content:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"text-center my-1 mx-auto",children:["测试二维码 ",(0,s.jsx)("br",{}),(0,s.jsx)("a",{target:"_blank",className:"ml-1 text-xs",href:X.c,rel:"noreferrer",children:"如何使用？"})]}),(0,s.jsx)(ea.A,{value:m,bordered:!1,className:"my-0 mx-auto"}),(0,s.jsx)("div",{className:"text-center my-0 mx-auto",children:a}),(0,s.jsxs)("div",{children:[(0,s.jsx)(b.A.TextArea,{readOnly:!0,autoSize:!0,value:m,className:"mb-1"}),(0,s.jsxs)("div",{className:"flex flex-row items-center",children:[(0,s.jsx)(el.A,{className:"mr-4",checked:r,onChange:e=>{let{target:a}=e;d(a.checked)},children:"使用 Deep Link："}),(0,s.jsx)(b.A,{placeholder:"例如 pushy://",className:"flex-1",value:t,onChange:e=>{let{target:a}=e;i(a.value)}})]})]})]}),children:(0,s.jsx)(h.Ay,{type:"link",icon:(0,s.jsx)(Z.A,{}),onClick:()=>{}})})},eo=[{title:"版本",dataIndex:"name",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"name",extra:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(Y,{deps:a.deps,name:"热更包 "+a.name}),(0,s.jsx)(_,{commit:a.commit}),(0,s.jsx)(ec,{name:a.name,hash:a.hash})]})})},{title:"描述",dataIndex:"description",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"description"})},{title:"自定义元信息",dataIndex:"metaInfo",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"metaInfo"})},{title:(0,s.jsxs)(F.A,{content:(0,s.jsxs)(s.Fragment,{children:["灰度发布测试中，需要 pushy 版本 v10.15.0 +。",(0,s.jsx)("br",{}),"低于此版本的只能全量发布。",(0,s.jsx)("br",{}),"取消绑定不会导致已更新的用户回滚。"]}),children:["绑定原生包 ",(0,s.jsx)(ee.A,{})]}),dataIndex:"packages",width:"100%",render:(e,a)=>{let{packages:l=[],id:n,config:t}=a;return(0,s.jsx)(ed,{config:t,packages:l,versionId:n})}},{title:"上传时间",dataIndex:"createdAt",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"createdAt",isEditable:!1})}],em=e=>{let{record:a,recordKey:l,isEditable:n=!0,extra:t}=e,{appId:i}=w(),d=a[l];if("createdAt"===l){let e=new Date(d),a=e.getFullYear(),l=e.getMonth()+1,s=l<10?`0${l}`:l,n=10>e.getDate()?`0${e.getDate()}`:e.getDate(),t=10>e.getHours()?`0${e.getHours()}`:e.getHours(),i=10>e.getMinutes()?`0${e.getMinutes()}`:e.getMinutes();d=`${a}-${s}-${n} ${t}:${i}`}let c=null;return n&&(c={editing:!1,onStart(){var e;let n=d;r.A.confirm({icon:null,width:"metaInfo"===l?640:void 0,title:null==(e=eo.find(e=>e.dataIndex===l))?void 0:e.title,closable:!0,maskClosable:!0,content:"metaInfo"===l?(0,s.jsx)(B,{className:"h-96",content:{text:d??""},onChange:e=>{d=e.text}}):(0,s.jsx)(b.A.TextArea,{defaultValue:d,onChange:e=>{let{target:a}=e;d=a.value}}),async onOk(){n=d,await y.F.updateVersion({appId:i,versionId:a.id,params:{[l]:d}})},async onCancel(){d=n}})}}),(0,s.jsxs)("div",{children:[(0,s.jsx)(C.A.Text,{className:"w-40",editable:c,ellipsis:!0,children:d}),t]})};function ex(){let{appId:e}=w(),[a,l]=(0,A.useState)([]),[n,t]=(0,A.useState)(0),[i,d]=(0,A.useState)(10),{versions:c,count:o,isLoading:m}=(0,g.jh)({appId:e,offset:n,limit:i});return(0,s.jsx)(es.A,{className:"versions",rowKey:"id",title:()=>"热更新包",columns:eo,dataSource:c,pagination:{showSizeChanger:!0,total:o,current:n/i+1,pageSize:i,showTotal:e=>`共 ${e} 个 `,onChange(e,a){a&&(t((e-1)*a),d(a))}},rowSelection:{selections:[es.A.SELECTION_ALL,es.A.SELECTION_INVERT,es.A.SELECTION_NONE],onChange:e=>l(e)},loading:m,footer:a.length?()=>(0,s.jsx)(h.Ay,{onClick:()=>(function(e){let{selected:a,versions:l,appId:s}=e,n=[];for(let e of l)a.includes(e.id)&&n.push(e.name);r.A.confirm({title:"删除所选热更新包：",content:n.join("，"),maskClosable:!0,okButtonProps:{danger:!0},async onOk(){await Promise.all(a.map(e=>y.F.deleteVersion({appId:s,versionId:e})))}})})({selected:a,versions:c,appId:e}),danger:!0,children:"删除"}):void 0})}var eu=l(2437);let eh=()=>{let{packages:e,unusedPackages:a,packagesLoading:l}=w();return(0,s.jsxs)(t.A,{children:[(0,s.jsxs)(t.A.Sider,{theme:"light",className:"p-4 pt-0 mr-4 h-full rounded-lg",width:240,children:[(0,s.jsx)("div",{className:"py-4",children:"原生包"}),(0,s.jsxs)(i.A,{children:[(0,s.jsx)(i.A.TabPane,{tab:"全部",children:(0,s.jsx)(R,{dataSource:e,loading:l})},"all"),(0,s.jsx)(i.A.TabPane,{tab:"未使用",children:(0,s.jsx)(R,{dataSource:a,loading:l})},"unused")]})]}),(0,s.jsx)(t.A.Content,{className:"!p-0",children:(0,s.jsx)(ex,{})})]})},ep=()=>{let[e,a]=r.A.useModal(),l=Number((0,j.g)().id),{app:t}=(0,g.nm)(l),[i]=d.A.useForm();return(0,A.useEffect)(()=>{t&&i.setFieldsValue(t)},[t,i]),(0,s.jsxs)(d.A,{layout:"vertical",form:i,initialValues:t,children:[(0,s.jsxs)(c.A,{className:"mb-4",children:[(0,s.jsx)(o.A,{flex:1,children:(0,s.jsxs)(m.A,{children:[(0,s.jsx)(m.A.Item,{children:(0,s.jsx)(j.N_,{to:"/apps",children:"应用列表"})}),(0,s.jsxs)(m.A.Item,{children:[(0,s.jsx)(eu.A,{platform:null==t?void 0:t.platform,className:"mr-1"}),null==t?void 0:t.name,(null==t?void 0:t.status)==="paused"&&(0,s.jsx)(x.A,{className:"ml-2",children:"暂停"})]})]})}),(0,s.jsx)(u.A.Compact,{children:(0,s.jsx)(h.Ay,{type:"primary",icon:(0,s.jsx)(n.A,{}),onClick:()=>{e.confirm({icon:null,closable:!0,maskClosable:!0,content:(0,s.jsx)(G,{}),async onOk(){try{await y.F.updateApp(l,{name:i.getFieldValue("name"),downloadUrl:i.getFieldValue("downloadUrl"),status:i.getFieldValue("status"),ignoreBuildTime:i.getFieldValue("ignoreBuildTime")})}catch(e){p.Ay.error(e.message);return}p.Ay.success("修改成功")}})},children:"应用设置"})})]}),(0,s.jsxs)($,{appId:l,children:[a,(0,s.jsx)(eh,{})]})]})},ej=ep}}]);