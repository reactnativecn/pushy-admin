"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["15"],{1586(e,t,l){l.r(t),l.d(t,{Component:()=>j});var r=l(4848),a=l(7833),s=l(2454),n=l(6287),o=l(8150),i=l(4840),u=l(3133),c=l(2685),d=l(8448),h=l(8032),m=l(4353),g=l.n(m),v=l(6540),p=l(391);let{Title:f}=n.A,{RangePicker:x}=o.A,y="total",b=[{label:"rn",value:"rn"},{label:"os",value:"os"},{label:"rnu",value:"rnu"}],j=()=>{let[e,t]=(0,v.useState)([g()().subtract(24,"hour"),g()()]),[l,n]=(0,v.useState)("pv"),[o,m]=(0,v.useState)("rn"),j=(0,v.useRef)([]),{data:M,isLoading:A}=(0,s.I)({queryKey:["globalMetrics",e[0].toISOString(),e[1].toISOString(),l],queryFn:()=>p.F.getGlobalMetrics({start:e[0].toISOString(),end:e[1].toISOString(),mode:l}),enabled:!!e[0]&&!!e[1]}),S=(0,v.useMemo)(()=>{if(!(null==M?void 0:M.data)||!(null==M?void 0:M.dict))return[];let e=[];for(let t of M.data)for(let[l,r]of t.data){let a=M.dict[l]||"";if("_total"===a)continue;let s=a.replace("\x1f",": ");a.endsWith("\x1f")&&(s=a.replace("\x1f",": unknown")),e.push({time:t.time,value:r,category:s})}return e},[M]),w=(0,v.useMemo)(()=>S.length?S.filter(e=>{var t;let l;return(-1===(l=(t=e.category).indexOf(":"))?t.trim():t.slice(0,l).trim())===o}):[],[S,o]),F=(0,v.useMemo)(()=>{let e=new Map;for(let t of w)e.set(t.category,(e.get(t.category)||0)+t.value);return e},[w]),N=(0,v.useMemo)(()=>Array.from(F.entries()).sort((e,t)=>t[1]-e[1]).map(e=>{let[t]=e;return t}),[F]),C=(0,v.useMemo)(()=>{if(!w.length)return[];let e=new Map;for(let t of w)e.set(t.time,(e.get(t.time)||0)+t.value);return Array.from(e.entries()).map(e=>{let[t,l]=e;return{time:t,value:l,category:y}}).sort((e,t)=>g()(e.time).valueOf()-g()(t.time).valueOf())},[w]),O=(0,v.useMemo)(()=>{let e=N.slice(0,10);return 0===C.length?e:[y,...e]},[N,C]),k=(0,v.useMemo)(()=>0===N.length?[]:0===C.length?N:[y,...N],[N,C]),I=(0,v.useMemo)(()=>w.length||C.length?[...w,...C]:[],[w,C]);j.current=O;let B=(0,v.useMemo)(()=>{if(!w.length)return{total:0,categories:new Map};let e=0,t=new Map;for(let l of w){e+=l.value;let r=t.get(l.category)||0;t.set(l.category,r+l.value)}return{total:e,categories:t}},[w]),D=(0,v.useMemo)(()=>Array.from(B.categories.entries()).sort((e,t)=>t[1]-e[1]).slice(0,10),[B.categories]),R={interaction:{legendFilter:!0,tooltip:{shared:!0}},data:I,xField:e=>new Date(e.time),yField:"value",colorField:"category",shapeField:"smooth",axis:{x:{title:"时间",labelAutoRotate:!0,labelFormatter:e=>{let t=g()(e);return t.isValid()?t.format("MM/DD HH:mm"):e}},y:{title:l.toUpperCase()}},tooltip:{channel:"y"},legend:{position:"top"},scale:k.length?{color:{domain:k}}:void 0,onReady:e=>{let{chart:t}=e;try{t.on("afterrender",()=>{let e=j.current;e.length&&t.emit("legend:filter",{data:{channel:"color",values:e}})})}catch(e){console.error(e)}},height:480};return(0,r.jsx)("div",{className:"p-6",children:(0,r.jsxs)(i.A,{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)(f,{level:4,className:"m-0!",children:"全局数据统计"}),(0,r.jsxs)(u.A,{children:[(0,r.jsxs)(c.A.Group,{value:l,onChange:e=>n(e.target.value),children:[(0,r.jsx)(c.A.Button,{value:"pv",children:"PV"}),(0,r.jsx)(c.A.Button,{value:"uv",children:"UV"})]}),(0,r.jsx)(d.A,{placeholder:"筛选 Key",showSearch:{optionFilterProp:"label"},value:o,options:b,onChange:e=>m(e),className:"w-40"}),(0,r.jsx)(x,{showTime:!0,value:e,onChange:e=>{(null==e?void 0:e[0])&&e[1]&&t([e[0],e[1]])},presets:[{label:"过去1小时",value:[g()().subtract(1,"hour"),g()()]},{label:"过去6小时",value:[g()().subtract(6,"hour"),g()()]},{label:"过去24小时",value:[g()().subtract(24,"hour"),g()()]},{label:"过去7天",value:[g()().subtract(7,"day"),g()()]},{label:"过去30天",value:[g()().subtract(30,"day"),g()()]}]})]})]}),(0,r.jsxs)(h.A,{spinning:A,children:[(0,r.jsx)(i.A,{size:"small",style:{marginBottom:20},children:I.length>0?(0,r.jsx)(a.A,{...R}):(0,r.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"暂无数据"})}),D.length>0&&(0,r.jsx)(i.A,{title:"分类统计 (Top 10)",size:"small",children:(0,r.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:D.map(e=>{let[t,l]=e;return(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded",children:[(0,r.jsx)("div",{className:"text-xs text-gray-500 truncate",title:t,children:t}),(0,r.jsx)("div",{className:"text-lg font-semibold",children:l.toLocaleString()})]},t)})})})]})]})})}}}]);