"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["199"],{7107:function(e,a,l){l.r(a),l.d(a,{Manage:()=>ep,Component:()=>ej});var s=l(5893),n=l(9050),t=l(414),i=l(9264),r=l(2743),d=l(7715),c=l(1230),o=l(5746),m=l(7895),u=l(6685),x=l(7584),h=l(5930),p=l(3632),j=l(3796),g=l(1758),Z=l(8358),y=l(7294),v=l(7389),f=l(9840),k=l(3108),b=l(934),N=l(5850),C=l(3810);let I=(0,y.createContext)({appId:0,deepLink:"",setDeepLink:()=>{},packages:[],unusedPackages:[]}),w=()=>(0,y.useContext)(I),P=e=>{let{children:a,appId:l}=e,[n,t]=(0,y.useState)(window.localStorage.getItem(`${l}_deeplink`)??""),{packages:i=[],unusedPackages:r=[],isLoading:d}=(0,Z.cE)(l),c=(0,y.useMemo)(()=>({appId:l,deepLink:n,setDeepLink:t,packages:i,unusedPackages:r,packagesLoading:d}),[l,n,i,r,d]);return(0,s.jsx)(I.Provider,{value:c,children:a})};var $=l(8402),S=l(7484),D=l.n(S),O=l(3458),V=l.n(O),E=l(8501);let F=e=>{let{commit:a}=e;if(!a)return(0,s.jsx)($.Z,{className:"ant-typography-edit",content:(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"text-center my-1 mx-auto",children:[(0,s.jsx)("div",{className:"font-bold",children:"最近的提交："}),(0,s.jsx)("div",{className:"text-gray-500",children:"需要使用 cli v1.42.0+ 版本上传，且使用 git 管理代码才能查看提交记录"})]})}),children:(0,s.jsx)(h.ZP,{type:"link",icon:(0,s.jsx)(E.Z,{}),onClick:()=>{}})});let{origin:l,hash:n,message:t,author:i}=a,r="";if(l)try{let{owner:e,name:a,source:s}=V()(l);r=`https://${s}/${e}/${a}/commit/${n}`}catch(e){console.error(e)}let d=D()(1e3*a.timestamp);return(0,s.jsx)($.Z,{className:"ant-typography-edit",content:(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"my-1 mx-auto",children:[(0,s.jsx)("div",{className:"font-bold",children:"最近的提交："}),(0,s.jsxs)("div",{children:["作者：",i]}),(0,s.jsxs)("div",{children:["时间：",d.fromNow(),"（",d.format("YYYY-MM-DD HH:mm:ss"),"）"]}),(0,s.jsxs)("div",{children:["摘要：",t]}),(0,s.jsx)("hr",{}),r?(0,s.jsx)("a",{className:"text-xs",href:r,target:"_blank",rel:"noreferrer",children:n}):(0,s.jsx)("span",{className:"text-xs",children:n})]})}),children:(0,s.jsx)(h.ZP,{type:"link",icon:(0,s.jsx)(E.Z,{}),onClick:()=>{}})})};var T=l(3464),A=l(4622),_=l(5190);function B(e){let{className:a,...l}=e,n=(0,y.useRef)(null),t=(0,y.useRef)(null);return(0,y.useEffect)(()=>(t.current=(0,_.po)({target:n.current,props:{mode:_.AR.text,...l}}),()=>{t.current&&t.current.destroy()}),[]),(0,y.useEffect)(()=>{var e;null==(e=t.current)||e.updateProps(l)},[l]),(0,s.jsx)("div",{className:a,ref:n})}var M=l(9852),L=l(6676);l(9492);let K=new M.Z({detectCircular:!0,maxDepth:1/0,showModifications:!0,arrayDiffMethod:"lcs"}),z=e=>{let{oldDeps:a,newDeps:l}=e;if(!a||!l)return null;let n=K.diff(a,l);return(0,s.jsx)(L.Z,{diff:n,highlightInlineDiff:!0})},H=e=>{let{deps:a,name:l}=e,{packages:n,appId:t}=w(),{versions:i}=(0,Z.gB)({appId:t,limit:1e3}),[r,d]=(0,y.useState)(null);return(0,s.jsx)($.Z,{className:"ant-typography-edit",afterOpenChange:e=>{e||d(null)},content:(0,s.jsx)("div",{children:(0,s.jsx)("div",{className:"text-center my-1 mx-auto",children:a?(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,s.jsxs)("h4",{children:["JavaScript 依赖列表",!r&&`(${l})`,(0,s.jsx)("div",{children:r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:"font-normal",children:r.newName}),` <-> ${l}`]})}),(0,s.jsx)("div",{className:"absolute right-8 top-7",children:r?(0,s.jsx)(h.ZP,{className:"content-end",onClick:()=>{d(null)},children:"返回"}):(0,s.jsx)(A.Z.Button,{className:"",menu:{items:[{key:"package",type:"group",label:"原生包",children:n.filter(e=>!!e.deps).map(e=>({key:`p_${e.id}`,label:e.name}))},{key:"version",type:"group",label:"热更包",children:i.filter(e=>!!e.deps).map(e=>({key:`v_${e.id}`,label:e.name}))}],onClick:e=>{let{key:l}=e,[s,t]=l.split("_");if("p"===s){let e=n.find(e=>e.id===+t);d({oldDeps:null==e?void 0:e.deps,newDeps:a,newName:"原生包 "+(null==e?void 0:e.name)})}else{let e=i.find(e=>e.id===+t);d({oldDeps:null==e?void 0:e.deps,newDeps:a,newName:"热更包 "+(null==e?void 0:e.name)})}}},children:"对比变更"})})]}),(0,s.jsx)("div",{className:"max-h-[50vh] overflow-y-auto",children:r?(0,s.jsx)(z,{oldDeps:r.oldDeps,newDeps:r.newDeps}):(0,s.jsx)(B,{content:{json:Object.keys(a).sort().reduce((e,l)=>(e[l]=a[l],e),{})},mode:_.AR.tree,mainMenuBar:!1,statusBar:!1,readOnly:!0})}),(0,s.jsxs)("div",{className:"text-gray-500 my-4",children:["仅在",(0,s.jsx)("span",{className:"font-bold underline",children:"上传"}),"时抓取package.json的直接依赖， 不保证严格匹配包内容，仅供参考。"]})]})}):(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"JavaScript 依赖列表"}),(0,s.jsx)("div",{className:"text-gray-500",children:"需要使用 cli v1.42.0+ 版本上传才能查看依赖列表"})]})})}),children:(0,s.jsx)(h.ZP,{type:"link",icon:(0,s.jsx)(T.Z,{}),onClick:()=>{}})})},R=e=>{let{dataSource:a,loading:l}=e;return(0,s.jsx)(k.Z,{loading:l,className:"packages",size:"small",dataSource:a,renderItem:e=>(0,s.jsx)(U,{item:e})})},U=e=>{let{item:a}=e,{appId:l}=w();return(0,s.jsx)("div",{className:"bg-white my-0 [&_li]:!px-0",children:(0,s.jsx)(k.Z.Item,{className:"p-2",children:(0,s.jsx)(k.Z.Item.Meta,{title:(0,s.jsxs)(c.Z,{align:"middle",children:[(0,s.jsxs)(o.Z,{flex:1,children:[a.name,a.status&&"normal"!==a.status&&(0,s.jsx)(u.Z,{className:"ml-2",children:Y[a.status]})]}),(0,s.jsx)(H,{deps:a.deps,name:"原生包 "+a.name}),(0,s.jsx)(F,{commit:a.commit}),(0,s.jsx)(h.ZP,{type:"link",icon:(0,s.jsx)(v.Z,{}),onClick:()=>(function(e,a){let{note:l,status:n}=e;r.Z.confirm({icon:null,closable:!0,maskClosable:!0,content:(0,s.jsxs)(d.Z,{layout:"vertical",initialValues:e,children:[(0,s.jsx)(d.Z.Item,{name:"note",label:"备注",children:(0,s.jsx)(b.Z,{placeholder:"添加原生包备注",onChange:e=>{let{target:a}=e;return l=a.value}})}),(0,s.jsx)(d.Z.Item,{name:"status",label:"状态",children:(0,s.jsxs)(N.Z,{onSelect:e=>{n=e},children:[(0,s.jsx)(N.Z.Option,{value:"normal",children:"正常"}),(0,s.jsx)(N.Z.Option,{value:"paused",children:"暂停"}),(0,s.jsx)(N.Z.Option,{value:"expired",children:"过期"})]})})]}),async onOk(){await g.h.updatePackage({appId:a,packageId:e.id,params:{note:l,status:n}})}})})(a,l)}),(0,s.jsx)(h.ZP,{type:"link",icon:(0,s.jsx)(f.Z,{}),onClick:()=>{r.Z.confirm({title:`\u{5220}\u{9664}\u{540E}\u{65E0}\u{6CD5}\u{6062}\u{590D}\u{FF0C}\u{786E}\u{5B9A}\u{5220}\u{9664}\u{539F}\u{751F}\u{5305}\u{201C}${a.name}\u{201D}\u{FF1F}`,maskClosable:!0,okButtonProps:{danger:!0},async onOk(){await g.h.deletePackage({appId:l,packageId:a.id})}})},danger:!0})]}),description:(0,s.jsxs)("div",{children:[a.note&&(0,s.jsxs)(C.Z.Paragraph,{className:"mb-0",type:"secondary",ellipsis:{tooltip:a.note},children:["备注：",a.note]}),(0,s.jsx)("div",{className:"text-xs flex flex-col gap-1",children:(0,s.jsxs)("div",{children:["编译时间：",a.buildTime]})})]})})})})},Y={paused:"暂停",expired:"过期"};var J=l(5781),W=l(1921),q=l(4005);let G=()=>{let{user:e}=(0,Z.Pc)(),{appId:a}=w(),l=d.Z.useWatch("appKey"),n=d.Z.useWatch("ignoreBuildTime");return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(d.Z.Item,{label:"AppId",layout:"vertical",children:(0,s.jsx)(C.Z.Paragraph,{className:"!mb-0",type:"secondary",copyable:!0,children:a})}),(0,s.jsx)(d.Z.Item,{label:"AppKey",name:"appKey",layout:"vertical",children:(0,s.jsx)(C.Z.Paragraph,{className:"!mb-0",type:"secondary",copyable:!0,children:l})}),(0,s.jsx)(d.Z.Item,{label:"应用名",name:"name",layout:"vertical",children:(0,s.jsx)(b.Z,{})}),(0,s.jsx)(d.Z.Item,{label:"原生包下载地址（当用户端的原生版本过期时，会使用此地址下载）",name:"downloadUrl",layout:"vertical",children:(0,s.jsx)(b.Z,{})}),(0,s.jsx)(d.Z.Item,{layout:"vertical",label:"启用热更新",name:"status",normalize:e=>e?"normal":"paused",getValueProps:e=>({value:"normal"===e||null==e}),children:(0,s.jsx)(q.Z,{checkedChildren:"已启用",unCheckedChildren:"已暂停"})}),(0,s.jsx)(d.Z.Item,{layout:"vertical",label:"忽略编译时间戳（高级版以上可启用）",name:"ignoreBuildTime",normalize:e=>e?"enabled":"disabled",getValueProps:e=>({value:"enabled"===e}),children:(0,s.jsx)(q.Z,{disabled:((null==e?void 0:e.tier)==="free"||(null==e?void 0:e.tier)==="standard")&&"enabled"!==n,checkedChildren:"已启用",unCheckedChildren:"已禁用"})}),(0,s.jsx)(d.Z.Item,{label:"删除应用",layout:"vertical",children:(0,s.jsx)(h.ZP,{type:"primary",icon:(0,s.jsx)(W.Z,{}),onClick:()=>{r.Z.confirm({title:"应用删除后无法恢复",okText:"确认删除",okButtonProps:{danger:!0},async onOk(){await g.h.deleteApp(a),r.Z.destroyAll(),J.Nd.navigate(J.BS.apps)}})},danger:!0,children:"删除"})})]})};var Q=l(1271),X=l(4918),ee=l(3546),ea=l(7233),el=l(9478),es=l(3174),en=l(5401),et=l(4585),ei=l(8537),er=l(6207);let ed=e=>{let{packages:a,versionId:l,config:n}=e,{packages:t,appId:i}=w(),r=t.filter(e=>!a.some(a=>e.id===a.id)),d=a.map(e=>{var a;let t=null==n||null==(a=n.rollout)?void 0:a[e.name],r=100===t||null==t,d=Number(t),c={items:r?[]:[{key:"full",label:"全量",icon:(0,s.jsx)(en.Z,{}),onClick:()=>{g.h.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:null}}}}),g.h.updatePackage({appId:i,packageId:e.id,params:{versionId:l}})}}]};d<50&&!r&&c.items.push({key:"gray",label:"灰度",icon:(0,s.jsx)(et.Z,{}),onClick:()=>g.h.updatePackage({appId:i,packageId:e.id,params:{versionId:l}}),children:[1,2,5,10,20,50].filter(e=>e>d).map(a=>({key:`${a}`,label:`${a}%`,onClick:()=>g.h.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:a}}}})}))}),c.items.length>0&&c.items.push({type:"divider"}),c.items.push({key:"unpublish",label:"取消绑定",icon:(0,s.jsx)(ei.Z,{}),onClick:()=>{g.h.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:null}}}}),g.h.updatePackage({appId:i,packageId:e.id,params:{versionId:null}})}});let o=(0,s.jsxs)(h.ZP,{size:"small",color:"primary",variant:r?"filled":"dashed",children:[(0,s.jsx)("span",{className:"font-bold",children:e.name}),(0,s.jsx)("span",{className:"text-xs",children:r?"":`(${t}%)`})]});return(0,s.jsx)(A.Z,{menu:c,children:o},e.id)});return(0,s.jsxs)("div",{className:"flex flex-wrap gap-1",children:[d,0!==r.length&&(0,s.jsx)(A.Z,{menu:{items:r.map(e=>({key:e.id,label:e.name,onClick:()=>g.h.updatePackage({appId:i,packageId:e.id,params:{versionId:l}}),children:[{key:"full",label:"全量",icon:(0,s.jsx)(en.Z,{}),onClick:()=>g.h.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:null}}}})},{key:"gray",label:"灰度",icon:(0,s.jsx)(et.Z,{}),children:[1,2,5,10,20,50].map(a=>({key:`${a}`,label:`${a}%`,onClick:()=>g.h.updateVersion({appId:i,versionId:l,params:{config:{rollout:{[e.name]:a}}}})}))}]}))},className:"ant-typography-edit",children:(0,s.jsx)(h.ZP,{type:"link",size:"small",icon:(0,s.jsx)(er.Z,{}),children:"绑定"})})]})},ec=e=>{let{name:a,hash:l}=e,{appId:n,deepLink:t,setDeepLink:i}=w(),[r,d]=(0,y.useState)(!!t),c=r&&t.endsWith("://");(0,y.useEffect)(()=>{c&&window.localStorage.setItem(`${n}_deeplink`,t)},[n,t,c]);let o={type:"__rnPushyVersionHash",data:l},m=c?`${t}?${new URLSearchParams(o).toString()}`:JSON.stringify(o);return(0,s.jsx)($.Z,{className:"ant-typography-edit",content:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"text-center my-1 mx-auto",children:["测试二维码 ",(0,s.jsx)("br",{}),(0,s.jsx)("a",{target:"_blank",className:"ml-1 text-xs",href:Q.x,rel:"noreferrer",children:"如何使用？"})]}),(0,s.jsx)(ea.Z,{value:m,bordered:!1,className:"my-0 mx-auto"}),(0,s.jsx)("div",{className:"text-center my-0 mx-auto",children:a}),(0,s.jsxs)("div",{children:[(0,s.jsx)(b.Z.TextArea,{readOnly:!0,autoSize:!0,value:m,className:"mb-1"}),(0,s.jsxs)("div",{className:"flex flex-row items-center",children:[(0,s.jsx)(el.Z,{className:"mr-4",checked:r,onChange:e=>{let{target:a}=e;d(a.checked)},children:"使用 Deep Link："}),(0,s.jsx)(b.Z,{placeholder:"例如 pushy://",className:"flex-1",value:t,onChange:e=>{let{target:a}=e;i(a.value)}})]})]})]}),children:(0,s.jsx)(h.ZP,{type:"link",icon:(0,s.jsx)(X.Z,{}),onClick:()=>{}})})},eo=[{title:"版本",dataIndex:"name",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"name",extra:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(H,{deps:a.deps,name:"热更包 "+a.name}),(0,s.jsx)(F,{commit:a.commit}),(0,s.jsx)(ec,{name:a.name,hash:a.hash})]})})},{title:"描述",dataIndex:"description",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"description"})},{title:"自定义元信息",dataIndex:"metaInfo",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"metaInfo"})},{title:(0,s.jsxs)($.Z,{content:(0,s.jsxs)(s.Fragment,{children:["灰度发布测试中，需要 pushy 版本 v10.15.0 +。",(0,s.jsx)("br",{}),"低于此版本的只能全量发布。",(0,s.jsx)("br",{}),"取消绑定不会导致已更新的用户回滚。"]}),children:["绑定原生包 ",(0,s.jsx)(ee.Z,{})]}),dataIndex:"packages",width:"100%",render:(e,a)=>{let{packages:l=[],id:n,config:t}=a;return(0,s.jsx)(ed,{config:t,packages:l,versionId:n})}},{title:"上传时间",dataIndex:"createdAt",render:(e,a)=>(0,s.jsx)(em,{record:a,recordKey:"createdAt",isEditable:!1})}],em=e=>{let{record:a,recordKey:l,isEditable:n=!0,extra:t}=e,{appId:i}=w(),d=a[l];if("createdAt"===l){let e=new Date(d),a=e.getFullYear(),l=e.getMonth()+1,s=l<10?`0${l}`:l,n=10>e.getDate()?`0${e.getDate()}`:e.getDate(),t=10>e.getHours()?`0${e.getHours()}`:e.getHours(),i=10>e.getMinutes()?`0${e.getMinutes()}`:e.getMinutes();d=`${a}-${s}-${n} ${t}:${i}`}let c=null;return n&&(c={editing:!1,onStart(){var e;let n=d;r.Z.confirm({icon:null,width:"metaInfo"===l?640:void 0,title:null==(e=eo.find(e=>e.dataIndex===l))?void 0:e.title,closable:!0,maskClosable:!0,content:"metaInfo"===l?(0,s.jsx)(B,{className:"h-96",content:{text:d??""},onChange:e=>{d=e.text}}):(0,s.jsx)(b.Z.TextArea,{defaultValue:d,onChange:e=>{let{target:a}=e;d=a.value}}),async onOk(){n=d,await g.h.updateVersion({appId:i,versionId:a.id,params:{[l]:d}})},async onCancel(){d=n}})}}),(0,s.jsxs)("div",{children:[(0,s.jsx)(C.Z.Text,{className:"w-40",editable:c,ellipsis:!0,children:d}),t]})};function eu(){let{appId:e}=w(),[a,l]=(0,y.useState)([]),[n,t]=(0,y.useState)(0),[i,d]=(0,y.useState)(10),{versions:c,count:o,isLoading:m}=(0,Z.gB)({appId:e,offset:n,limit:i});return(0,s.jsx)(es.Z,{className:"versions",rowKey:"id",title:()=>"热更新包",columns:eo,dataSource:c,pagination:{showSizeChanger:!0,total:o,current:n/i+1,pageSize:i,showTotal:e=>`\u{5171} ${e} \u{4E2A} `,onChange(e,a){a&&(t((e-1)*a),d(a))}},rowSelection:{selections:[es.Z.SELECTION_ALL,es.Z.SELECTION_INVERT,es.Z.SELECTION_NONE],onChange:e=>l(e)},loading:m,footer:a.length?()=>(0,s.jsx)(h.ZP,{onClick:()=>(function(e){let{selected:a,versions:l,appId:s}=e,n=[];for(let e of l)a.includes(e.id)&&n.push(e.name);r.Z.confirm({title:"删除所选热更新包：",content:n.join("，"),maskClosable:!0,okButtonProps:{danger:!0},async onOk(){await Promise.all(a.map(e=>g.h.deleteVersion({appId:s,versionId:e})))}})})({selected:a,versions:c,appId:e}),danger:!0,children:"删除"}):void 0})}var ex=l(8785);let eh=()=>{let{packages:e,unusedPackages:a,packagesLoading:l}=w();return(0,s.jsxs)(t.Z,{children:[(0,s.jsxs)(t.Z.Sider,{theme:"light",className:"p-4 pt-0 mr-4 h-full rounded-lg",width:240,children:[(0,s.jsx)("div",{className:"py-4",children:"原生包"}),(0,s.jsxs)(i.Z,{children:[(0,s.jsx)(i.Z.TabPane,{tab:"全部",children:(0,s.jsx)(R,{dataSource:e,loading:l})},"all"),(0,s.jsx)(i.Z.TabPane,{tab:"未使用",children:(0,s.jsx)(R,{dataSource:a,loading:l})},"unused")]})]}),(0,s.jsx)(t.Z.Content,{className:"!p-0",children:(0,s.jsx)(eu,{})})]})},ep=()=>{let[e,a]=r.Z.useModal(),l=Number((0,j.UO)().id),{app:t}=(0,Z.qD)(l),[i]=d.Z.useForm();return(0,y.useEffect)(()=>{t&&i.setFieldsValue(t)},[t,i]),(0,s.jsxs)(d.Z,{layout:"vertical",form:i,initialValues:t,children:[(0,s.jsxs)(c.Z,{className:"mb-4",children:[(0,s.jsx)(o.Z,{flex:1,children:(0,s.jsxs)(m.Z,{children:[(0,s.jsx)(m.Z.Item,{children:(0,s.jsx)(j.rU,{to:"/apps",children:"应用列表"})}),(0,s.jsxs)(m.Z.Item,{children:[(0,s.jsx)(ex.Z,{platform:null==t?void 0:t.platform,className:"mr-1"}),null==t?void 0:t.name,(null==t?void 0:t.status)==="paused"&&(0,s.jsx)(u.Z,{className:"ml-2",children:"暂停"})]})]})}),(0,s.jsx)(x.Z.Compact,{children:(0,s.jsx)(h.ZP,{type:"primary",icon:(0,s.jsx)(n.Z,{}),onClick:()=>{e.confirm({icon:null,closable:!0,maskClosable:!0,content:(0,s.jsx)(G,{}),async onOk(){try{await g.h.updateApp(l,{name:i.getFieldValue("name"),downloadUrl:i.getFieldValue("downloadUrl"),status:i.getFieldValue("status"),ignoreBuildTime:i.getFieldValue("ignoreBuildTime")})}catch(e){p.ZP.error(e.message);return}p.ZP.success("修改成功")}})},children:"应用设置"})})]}),(0,s.jsxs)(P,{appId:l,children:[a,(0,s.jsx)(eh,{})]})]})},ej=ep}}]);