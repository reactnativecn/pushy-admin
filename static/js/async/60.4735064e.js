"use strict";(self.webpackChunkpushy_admin=self.webpackChunkpushy_admin||[]).push([["60"],{9647(e,t,l){l.r(t),l.d(t,{Component:()=>H});var a=l(4848),r=l(7833),n=l(2454),s=l(6287),i=l(3494),o=l(4840),c=l(2061),u=l(3271),d=l(8032),m=l(6540),f=l(8248),g=l(682),p=l(9302),v=l(4164),h=l(5541),x=l(2279),y=l(2441);let b=e=>{let t,{value:l,formatter:a,precision:r,decimalSeparator:n,groupSeparator:s="",prefixCls:i}=e;if("function"==typeof a)t=a(l);else{let e=String(l),a=e.match(/^(-?)(\d*)(\.(\d+))?$/);if(a&&"-"!==e){let e=a[1],l=a[2]||"0",o=a[4]||"";l=l.replace(/\B(?=(\d{3})+(?!\d))/g,s),"number"==typeof r&&(o=o.padEnd(r,"0").slice(0,r>0?r:0)),o&&(o=`${n}${o}`),t=[m.createElement("span",{key:"int",className:`${i}-content-value-int`},e,l),o&&m.createElement("span",{key:"decimal",className:`${i}-content-value-decimal`},o)]}else t=e}return m.createElement("span",{className:`${i}-content-value`},t)};var w=l(5905),$=l(7358),M=l(8986);let j=(0,$.OF)("Statistic",e=>(e=>{let{componentCls:t,marginXXS:l,padding:a,colorTextDescription:r,titleFontSize:n,colorTextHeading:s,contentFontSize:i,fontFamily:o}=e;return{[t]:{...(0,w.dF)(e),[`${t}-header`]:{paddingBottom:l,[`${t}-title`]:{color:r,fontSize:n}},[`${t}-skeleton`]:{paddingTop:a},[`${t}-content`]:{color:s,fontSize:i,fontFamily:o,[`${t}-content-value`]:{display:"inline-block",direction:"ltr"},[`${t}-content-prefix, ${t}-content-suffix`]:{display:"inline-block"},[`${t}-content-prefix`]:{marginInlineEnd:l},[`${t}-content-suffix`]:{marginInlineStart:l}}}}})((0,M.oX)(e,{})),e=>{let{fontSizeHeading3:t,fontSize:l}=e;return{titleFontSize:l,contentFontSize:t}}),N=m.forwardRef((e,t)=>{let{prefixCls:l,className:a,rootClassName:r,style:n,valueStyle:s,value:i=0,title:o,valueRender:c,prefix:u,suffix:d,loading:f=!1,formatter:g,precision:w,decimalSeparator:$=".",groupSeparator:M=",",onMouseEnter:N,onMouseLeave:S,styles:A,classNames:E,...F}=e,{getPrefixCls:k,direction:I,className:C,style:z,classNames:D,styles:O}=(0,x.TP)("statistic"),R=k("statistic",l),[T,H]=j(R),L={...e,decimalSeparator:$,groupSeparator:M,loading:f,value:i},[q,B]=(0,h.AV)([D,E],[O,A],{props:L}),_=m.createElement(b,{decimalSeparator:$,groupSeparator:M,prefixCls:R,formatter:g,precision:w,value:i}),G=(0,v.$)(R,{[`${R}-rtl`]:"rtl"===I},C,a,r,q.root,T,H),K=(0,v.$)(`${R}-header`,q.header),P=(0,v.$)(`${R}-title`,q.title),V=(0,v.$)(`${R}-content`,q.content),W=(0,v.$)(`${R}-content-prefix`,q.prefix),X=(0,v.$)(`${R}-content-suffix`,q.suffix),Y=m.useRef(null);m.useImperativeHandle(t,()=>({nativeElement:Y.current}));let J=(0,p.A)(F,{aria:!0,data:!0});return m.createElement("div",{...J,className:G,style:{...B.root,...z,...n},ref:Y,onMouseEnter:N,onMouseLeave:S},o&&m.createElement("div",{className:K,style:B.header},m.createElement("div",{className:P,style:B.title},o)),m.createElement(y.A,{paragraph:!1,loading:f,className:`${R}-skeleton`,active:!0},m.createElement("div",{className:V,style:{...s,...B.content}},u&&m.createElement("span",{className:W,style:B.prefix},u),c?c(_):_,d&&m.createElement("span",{className:X,style:B.suffix},d))))}),S=[["Y",31536e6],["M",2592e6],["D",864e5],["H",36e5],["m",6e4],["s",1e3],["S",1]],A=1e3/60,E=e=>{let{value:t,format:l="HH:mm:ss",onChange:a,onFinish:r,type:n,...s}=e,i="countdown"===n,[o,c]=m.useState(null),u=(0,f._q)(()=>{let e=Date.now(),l=new Date(t).getTime();c({});let n=i?l-e:e-l;return a?.(n),!i||!(l<e)||(r?.(),!1)});return m.useEffect(()=>{let e;return e=window.setInterval(()=>{u()||window.clearInterval(e)},A),()=>{window.clearInterval(e)}},[t,i]),m.useEffect(()=>{c({})},[]),m.createElement(N,{...s,value:t,valueRender:e=>(0,g.Ob)(e,{title:void 0}),formatter:(e,t)=>o?function(e,t,l){let a,r,n,s,i,o,{format:c=""}=t,u=new Date(e).getTime(),d=Date.now();return a=l?Math.max(u-d,0):Math.max(d-u,0),r=/\[[^\]]*]/g,n=(c.match(r)||[]).map(e=>e.slice(1,-1)),s=c.replace(r,"[]"),i=S.reduce((e,[t,l])=>{if(e.includes(t)){let r=Math.floor(a/l);return a-=r*l,e.replace(RegExp(`${t}+`,"g"),e=>{let t=e.length;return r.toString().padStart(t,"0")})}return e},s),o=0,i.replace(r,()=>{let e=n[o];return o+=1,e})}(e,{...t,format:l},i):"-"})},F=m.memo(e=>m.createElement(E,{...e,type:"countdown"}));N.Timer=E,N.Countdown=F;var k=l(4353),I=l.n(k),C=l(391);let{Title:z}=s.A,{RangePicker:D}=i.A,O="total",R={pv:"请求数",uv:"用户数"},T=[{label:"rn",value:"rn"},{label:"os",value:"os"},{label:"rnu",value:"rnu"}],H=()=>{let[e,t]=(0,m.useState)([I()().subtract(24,"hour"),I()()]),[l,s]=(0,m.useState)("pv"),[i,f]=(0,m.useState)("rn"),g=(0,m.useRef)([]),p=e[0].toISOString(),v=e[1].toISOString(),{data:h,isLoading:x}=(0,n.I)({queryKey:["globalMetrics",p,v,"pv"],queryFn:()=>C.F.getGlobalMetrics({start:p,end:v,mode:"pv"}),enabled:!!e[0]&&!!e[1]}),{data:y,isLoading:b}=(0,n.I)({queryKey:["globalMetrics",p,v,"uv"],queryFn:()=>C.F.getGlobalMetrics({start:p,end:v,mode:"uv"}),enabled:!!e[0]&&!!e[1]}),w="pv"===l?h:y,$=(0,m.useMemo)(()=>{if(!(null==w?void 0:w.data)||!(null==w?void 0:w.dict))return[];let e=[];for(let t of w.data)for(let[l,a]of t.data){let r=w.dict[l]||"";if("_total"===r)continue;let n=r.replace("\x1f",": ");r.endsWith("\x1f")&&(n=r.replace("\x1f",": unknown")),e.push({time:t.time,value:a,category:n})}return e},[w]),M=(0,m.useMemo)(()=>$.length?$.filter(e=>{var t;let l;return(-1===(l=(t=e.category).indexOf(":"))?t.trim():t.slice(0,l).trim())===i}):[],[$,i]),j=(0,m.useMemo)(()=>{let e=new Map;for(let t of M)e.set(t.category,(e.get(t.category)||0)+t.value);return e},[M]),S=(0,m.useMemo)(()=>Array.from(j.entries()).sort((e,t)=>t[1]-e[1]).map(e=>{let[t]=e;return t}),[j]),A=(0,m.useMemo)(()=>{if(!M.length)return[];let e=new Map;for(let t of M)e.set(t.time,(e.get(t.time)||0)+t.value);return Array.from(e.entries()).map(e=>{let[t,l]=e;return{time:t,value:l,category:O}}).sort((e,t)=>I()(e.time).valueOf()-I()(t.time).valueOf())},[M]),E=(0,m.useMemo)(()=>{let e=S.slice(0,10);return 0===A.length?e:[O,...e]},[S,A]),F=(0,m.useMemo)(()=>0===S.length?[]:0===A.length?S:[O,...S],[S,A]),k=(0,m.useMemo)(()=>M.length||A.length?[...M,...A]:[],[M,A]);g.current=E;let H=e=>{if(!(null==e?void 0:e.data)||!e.dict)return 0;let t=0;for(let l of e.data){let a=0;for(let[t,r]of l.data){if("_total"===e.dict[t]){a=r;break}a+=r}t+=a}return t},L=(0,m.useMemo)(()=>H(h),[h]),q=(0,m.useMemo)(()=>H(y),[y]),B=(0,m.useMemo)(()=>{if(!M.length)return{total:0,categories:new Map};let e=0,t=new Map;for(let l of M){e+=l.value;let a=t.get(l.category)||0;t.set(l.category,a+l.value)}return{total:e,categories:t}},[M]),_=(0,m.useMemo)(()=>Array.from(B.categories.entries()).sort((e,t)=>t[1]-e[1]).slice(0,10),[B.categories]),G={interaction:{legendFilter:!0,tooltip:{shared:!0}},data:k,xField:e=>new Date(e.time),yField:"value",colorField:"category",shapeField:"smooth",axis:{x:{title:"时间",labelAutoRotate:!0,labelFormatter:e=>{let t=I()(e);return t.isValid()?t.format("MM/DD HH:mm"):e}},y:{title:R[l]}},tooltip:{channel:"y"},legend:{position:"top"},scale:F.length?{color:{domain:F}}:void 0,onReady:e=>{let{chart:t}=e;try{t.on("afterrender",()=>{let e=g.current;e.length&&t.emit("legend:filter",{data:{channel:"color",values:e}})})}catch(e){console.error(e)}},height:480};return(0,a.jsx)("div",{className:"page-section",children:(0,a.jsxs)(o.A,{children:[(0,a.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6",children:[(0,a.jsx)(z,{level:4,className:"m-0!",children:"全局数据统计"}),(0,a.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:flex-wrap md:items-center",children:[(0,a.jsxs)(c.A.Group,{value:l,onChange:e=>s(e.target.value),className:"w-full md:w-auto",children:[(0,a.jsx)(c.A.Button,{value:"pv",children:"请求数"}),(0,a.jsx)(c.A.Button,{value:"uv",children:"用户数"})]}),(0,a.jsx)(u.A,{placeholder:"筛选 Key",showSearch:{optionFilterProp:"label"},value:i,options:T,onChange:e=>f(e),className:"w-full md:w-40"}),(0,a.jsx)(D,{showTime:!0,value:e,onChange:e=>{(null==e?void 0:e[0])&&e[1]&&t([e[0],e[1]])},className:"w-full md:w-auto",presets:[{label:"过去1小时",value:[I()().subtract(1,"hour"),I()()]},{label:"过去6小时",value:[I()().subtract(6,"hour"),I()()]},{label:"过去24小时",value:[I()().subtract(24,"hour"),I()()]},{label:"过去7天",value:[I()().subtract(7,"day"),I()()]},{label:"过去30天",value:[I()().subtract(30,"day"),I()()]}]})]})]}),(0,a.jsxs)(d.A,{spinning:"pv"===l?x:b,children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[(0,a.jsx)(o.A,{size:"small",children:(0,a.jsx)(N,{title:"总请求数",value:x?"-":L.toLocaleString()})}),(0,a.jsx)(o.A,{size:"small",children:(0,a.jsx)(N,{title:"总用户数",value:b?"-":q.toLocaleString()})})]}),(0,a.jsx)(o.A,{size:"small",style:{marginBottom:20},children:k.length>0?(0,a.jsx)(r.A,{...G}):(0,a.jsx)("div",{className:"h-80 flex items-center justify-center text-gray-400",children:"暂无数据"})}),_.length>0&&(0,a.jsx)(o.A,{title:"分类统计 (Top 10)",size:"small",children:(0,a.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:_.map(e=>{let[t,l]=e;return(0,a.jsxs)("div",{className:"p-3 bg-gray-50 rounded",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 truncate",title:t,children:t}),(0,a.jsx)("div",{className:"text-lg font-semibold",children:l.toLocaleString()})]},t)})})})]})]})})}}}]);